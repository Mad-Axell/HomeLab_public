# base/set_locale - Роль настройки системной локализации

## Описание

Эта роль Ansible настраивает системную локализацию, часовой пояс, раскладку клавиатуры и консольный шрифт для Linux систем. Она обеспечивает комплексную поддержку семейств Debian/Ubuntu, RedHat/CentOS и SUSE с расширенной валидацией, возможностями отладки и структурированным логированием.

## Возможности

- **Кроссплатформенная поддержка**: Работает с семействами Debian, RedHat и SUSE
- **Комплексная валидация**: Предварительные проверки и валидация параметров
- **Структурированное логирование**: Логи в формате JSON для интеграции с агрегаторами логов
- **Автоматический откат**: Возможности резервного копирования и восстановления при ошибках
- **Двуязычная поддержка**: Документация и отладочный вывод на английском и русском языках
- **Режим отладки**: Подробный вывод для диагностики проблем
- **Идемпотентность**: Безопасно запускать несколько раз
- **Модульный дизайн**: OS-специфичные задачи для оптимальной совместимости
- **Генерация основной локали**: Обеспечивает генерацию основной локали перед конфигурацией
- **Многоязычная поддержка**: Настраивает дополнительные локали для интернационализации

## Требования

### Ansible
- **Минимальная версия**: 2.14+
- **Python**: 3.6+

### Поддерживаемые операционные системы

#### Семейство Debian
- Debian: 9, 10, 11, 12
- Ubuntu: 18.04, 20.04, 22.04, 24.04

#### Семейство RedHat
- RedHat Enterprise Linux: 7, 8, 9
- CentOS: 7, 8, 9
- Rocky Linux: 8, 9
- AlmaLinux: 8, 9

#### Семейство SUSE
- SUSE Linux Enterprise Server: Последние версии
- openSUSE: Последние версии

## Переменные роли

### Настройки отладки и резервного копирования

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `debug_mode` | bool | `true` | Включить подробный отладочный вывод |
| `debug_lang` | str | `'both'` | Язык отладки: `english`, `russian` или `both` |
| `debug_show_passwords` | bool | `false` | Показывать пароли в отладке (НЕБЕЗОПАСНО) |
| `backup_enabled` | bool | `true` | Включить резервное копирование файлов конфигурации |
| `backup_suffix` | str | `".backup"` | Суффикс для файлов резервных копий |

### Конфигурация часового пояса

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `timezone` | str | `"Europe/Moscow"` | Системный часовой пояс (например, UTC, Europe/Moscow) |
| `timezone_manage` | bool | `true` | Управлять ли конфигурацией часового пояса |

### Конфигурация локализации

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `locale_language` | str | `"en_US"` | Код основного языка локализации |
| `locale_encoding` | str | `"UTF-8"` | Кодировка локализации |
| `locale_primary` | str | `"en_US.UTF-8"` | Основная системная локализация |
| `locale_additional` | list | `["ru_RU.UTF-8"]` | Дополнительные локализации для многоязычной поддержки |
| `locale_variables` | dict | См. defaults | Системные переменные окружения локализации |

### Конфигурация консольного шрифта

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `console_font` | str | `"Lat2-Terminus16"` | Название консольного шрифта |
| `console_font_manage` | bool | `true` | Управлять ли консольным шрифтом |

### Конфигурация клавиатуры

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `keyboard_layout` | str | `"us"` | Раскладка клавиатуры (например, us, ru, de) |
| `keyboard_variant` | str | `""` | Вариант клавиатуры (например, dvorak, phonetic) |
| `keyboard_options` | str | `""` | Дополнительные опции клавиатуры |

### Настройки валидации

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `validate_parameters` | bool | `true` | Включить валидацию параметров |
| `strict_validation` | bool | `true` | Включить строгий режим валидации |

### Производительность и логирование

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `log_file` | str | `"/var/log/ansible-changes.log"` | Путь к файлу лога изменений |
| `async_timeout` | int | `300` | Таймаут асинхронных задач (секунды) |
| `retries` | int | `3` | Количество повторов для неудачных задач |
| `retry_delay` | int | `5` | Задержка между повторами (секунды) |
| `enable_rollback` | bool | `true` | Автоматический откат при ошибке |

## Зависимости

Отсутствуют.

## Пример плейбука

### Базовое использование

```yaml
---
- name: Настройка системной локализации
  hosts: all
  become: yes
  roles:
    - role: base/set_locale
      vars:
        locale_primary: "en_US.UTF-8"
        timezone: "UTC"
        keyboard_layout: "us"
        console_font: "Lat2-Terminus16"
```

### Расширенная конфигурация

```yaml
---
- name: Настройка системной локализации с расширенными параметрами
  hosts: all
  become: yes
  roles:
    - role: base/set_locale
      vars:
        # Настройки локализации
        locale_primary: "en_US.UTF-8"
        locale_additional:
          - "ru_RU.UTF-8"
          - "de_DE.UTF-8"
        
        # Часовой пояс
        timezone: "Europe/Moscow"
        
        # Клавиатура
        keyboard_layout: "us"
        keyboard_variant: "dvorak"
        
        # Консоль
        console_font: "Lat2-Terminus16"
        
        # Отладка и логирование
        debug_mode: true
        debug_lang: "both"
        log_file: "/var/log/locale-changes.log"
        
        # Валидация
        strict_validation: true
        validate_parameters: true
```

### Конфигурация для разных ОС

```yaml
---
- name: Настройка локализации для разных семейств ОС
  hosts: all
  become: yes
  roles:
    - role: base/set_locale
      vars:
        locale_primary: "en_US.UTF-8"
        timezone: "UTC"
        keyboard_layout: "us"
      when: ansible_os_family in ['Debian', 'RedHat', 'Suse']
```

## Процесс генерации локалей

Роль реализует комплексный процесс генерации локалей для систем Debian/Ubuntu:

### Генерация основной локали
1. **Автоматическая генерация**: Роль автоматически генерирует основную локаль (`locale_primary`) с помощью `community.general.locale_gen`
2. **Предварительная конфигурация**: Основная локаль генерируется перед установкой системных переменных локализации
3. **Обработка ошибок**: При ошибке генерации роль логирует ошибку и продолжает работу с доступными локалями
4. **Идемпотентность**: Безопасно запускать несколько раз - не будет перегенерировать существующие локали

### Дополнительные локали
1. **Многоязычная поддержка**: Настраивает дополнительные локали из списка `locale_additional`
2. **Пакетная обработка**: Генерирует все дополнительные локали в одной операции
3. **Валидация**: Убеждается, что все локали правильно отформатированы перед генерацией

### Последовательность процесса
```
1. Валидация параметров локализации
2. Генерация основной локали (только Debian/Ubuntu)
3. Генерация дополнительных локалей
4. Настройка системных переменных локализации
5. Установка часового пояса и раскладки клавиатуры
6. Применение настроек консольного шрифта
```

## Структурированное логирование

Роль реализует структурированное JSON логирование для всех изменений конфигурации. Записи логов включают:

```json
{
  "timestamp": "2024-01-15T10:30:45.123456Z",
  "level": "INFO",
  "event_type": "PRIMARY_LOCALE_GENERATED",
  "locale_primary": "en_US.UTF-8",
  "user": "ansible_user",
  "host": "target_host",
  "playbook": "locale_setup",
  "correlation_id": "1705312245",
  "message": "Primary locale generated successfully",
  "metadata": {
    "changed": true,
    "os_family": "Debian",
    "os_version": "12",
    "generation_method": "locale_gen"
  }
}
```

### Пример логирования ошибок
```json
{
  "timestamp": "2024-01-15T10:30:45.123456Z",
  "level": "ERROR",
  "event_type": "PRIMARY_LOCALE_GEN_FAILED",
  "locale_primary": "en_US.UTF-8",
  "user": "ansible_user",
  "host": "target_host",
  "playbook": "locale_setup",
  "correlation_id": "1705312245",
  "message": "Primary locale generation failed",
  "metadata": {
    "rollback_enabled": true,
    "os_family": "Debian",
    "os_version": "12",
    "error_type": "PRIMARY_LOCALE_GENERATION_ERROR"
  }
}
```

## Обработка ошибок

Роль реализует комплексную обработку ошибок:

- **Предварительные проверки**: Валидирует версию Ansible, совместимость ОС, версию Python и дисковое пространство
- **Валидация параметров**: Валидирует формат локализации, формат часового пояса, раскладки клавиатуры и консольные шрифты
- **Паттерн Block-Rescue**: Использует структурированную обработку ошибок с автоматическим откатом
- **Резервное копирование и восстановление**: Создает резервные копии перед изменениями и восстанавливает при ошибках

## Поведение для конкретных ОС

### Debian/Ubuntu
- Использует `apt` для управления пакетами
- Генерирует основную локаль с помощью `community.general.locale_gen`
- Настраивает `/etc/default/locale` и `/etc/locale.gen`
- Использует `debconf` для конфигурации клавиатуры
- Консольный шрифт в `/etc/default/console-setup`

### RedHat/CentOS
- Использует `yum`/`dnf` для управления пакетами
- Использует `localectl` для конфигурации локализации и клавиатуры
- Консольный шрифт в `/etc/vconsole.conf`

### SUSE
- Использует `zypper` для управления пакетами
- Использует `localectl` для конфигурации локализации и клавиатуры
- Консольный шрифт в `/etc/vconsole.conf`

## Паттерны валидации

Роль валидирует входные данные с помощью regex паттернов:

- **Паттерн локализации**: `^[a-z]{2}_[A-Z]{2}\.[A-Z0-9-]+$`
- **Паттерн часового пояса**: `^[A-Za-z0-9/_-]+$`
- **Раскладки клавиатуры**: Предопределенный список допустимых раскладок
- **Консольные шрифты**: Предопределенный список допустимых шрифтов

## Отладочный вывод

Включите режим отладки для подробного вывода:

```yaml
vars:
  debug_mode: true
  debug_lang: "both"  # или "english" или "russian"
```

Отладочный вывод включает:
- Системную информацию
- Результаты установки пакетов
- Изменения конфигурации
- Результаты валидации
- Сводки операций

## Устранение неполадок

### Распространенные проблемы

1. **Неверный формат локализации**
   - Убедитесь, что локализация следует формату: `ll_CC.ENCODING` (например, `en_US.UTF-8`)

2. **Локализация не сгенерирована (Debian/Ubuntu)**
   - Роль автоматически генерирует основную локаль с помощью `locale_gen`
   - Проверьте `/etc/locale.gen` на наличие раскомментированных записей локалей
   - Убедитесь, что локаль доступна в системном списке локалей

3. **Часовой пояс не найден**
   - Проверьте, что часовой пояс существует в `/usr/share/zoneinfo/`

4. **Раскладка клавиатуры не поддерживается**
   - Проверьте допустимые раскладки в списке `valid_keyboard_layouts`

5. **Отказ в доступе**
   - Убедитесь, что роль запускается с `become: yes`

### Команды отладки

```bash
# Проверить текущую локализацию
localectl status

# Проверить часовой пояс
timedatectl status

# Проверить раскладку клавиатуры
localectl status

# Просмотреть файл лога
tail -f /var/log/ansible-changes.log
```

## Лицензия

MIT

## Автор

Mad-Axell [mad.axell@gmail.com]

## Участие в разработке

1. Сделайте форк репозитория
2. Создайте ветку для функции
3. Внесите свои изменения
4. Добавьте тесты, если применимо
5. Отправьте pull request

## История изменений

### Версия 1.1.0
- Добавлена генерация основной локали для систем Debian/Ubuntu
- Улучшена обработка ошибок со структурированным JSON логированием для генерации локалей
- Расширены возможности отката для конфигурации локализации
- Обновлена документация с деталями генерации локалей

### Версия 1.0.0
- Первый релиз
- Кроссплатформенная поддержка для семейств Debian, RedHat и SUSE
- Комплексная валидация и обработка ошибок
- Структурированное JSON логирование
- Двуязычная документация и отладочный вывод
