# base/set_locale

Роль конфигурации системной локали для Ansible.

## Описание

Эта роль Ansible обеспечивает настройку системной локализации для систем Debian/Ubuntu. Роль обеспечивает правильную настройку локали, часового пояса, раскладки клавиатуры и консольного шрифта с валидацией и возможностями отладки.

## Возможности

- **Поддержка Debian/Ubuntu**: Оптимизирована для систем Debian и Ubuntu
- **Комплексная валидация**: Предварительные проверки и валидация параметров
- **Режим отладки**: Подробный вывод для диагностики проблем
- **Идемпотентность**: Безопасно запускать несколько раз
- **Упрощенный дизайн**: Чистый, поддерживаемый код без ненужной сложности
- **Сбор системной информации**: Автоматический сбор системной информации
- **Оптимизированная производительность**: Упрощенные обработчики и установка пакетов

## Требования

### Ansible
- **Минимальная версия**: 2.14+
- **Python**: 3.6+

### Поддерживаемые операционные системы

#### Семейство Debian
- Debian: 9, 10, 11, 12
- Ubuntu: 18.04, 20.04, 22.04, 24.04

## Переменные роли

### Настройки отладки и резервного копирования

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `debug_mode` | bool | `true` | Включить подробный отладочный вывод |
| `backup_enabled` | bool | `true` | Включить резервное копирование файлов конфигурации |
| `backup_suffix` | str | `".backup"` | Суффикс для файлов резервных копий |

### Конфигурация часового пояса

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `timezone` | str | `"Europe/Moscow"` | Системный часовой пояс |
| `timezone_manage` | bool | `true` | Управлять ли конфигурацией часового пояса |

### Конфигурация локализации

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `locale_primary` | str | `"en_US.UTF-8"` | Основная системная локализация |
| `locale_additional` | list | `["ru_RU.UTF-8", "en_GB.UTF-8"]` | Дополнительные локализации для генерации |
| `locale_variables` | dict | См. defaults | Системные переменные окружения локализации |

### Конфигурация консольного шрифта

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `console_font` | str | `"Lat2-Terminus16"` | Название консольного шрифта |
| `console_font_manage` | bool | `true` | Управлять ли конфигурацией консольного шрифта |

### Конфигурация клавиатуры

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `keyboard_layout` | str | `"us"` | Раскладка клавиатуры |
| `keyboard_variant` | str | `""` | Вариант клавиатуры |
| `keyboard_options` | str | `""` | Дополнительные опции клавиатуры |

### Настройки валидации

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `validate_parameters` | bool | `true` | Включить валидацию параметров |
| `strict_validation` | bool | `true` | Включить строгий режим валидации |

### Управление логированием и откатом

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `log_file` | str | `"/var/log/ansible-changes.log"` | Путь к файлу лога изменений |
| `enable_rollback` | bool | `true` | Автоматический откат при ошибке |

### Команды обработчиков

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `locale_reload_command` | str | `"locale-gen"` | Команда перезагрузки локали |
| `console_reload_command` | str | `"setupcon"` | Команда перезагрузки консоли |

## Зависимости

Отсутствуют. Роль разработана как независимая и самодостаточная.

## Пример Playbook

```yaml
---
- name: Настройка системной локализации
  hosts: all
  become: yes
  roles:
    - role: base/set_locale
      vars:
        # Настройки локали
        locale_primary: "en_US.UTF-8"
        locale_additional:
          - "ru_RU.UTF-8"
          - "de_DE.UTF-8"
        
        # Часовой пояс
        timezone: "Europe/Moscow"
        timezone_manage: true
        
        # Клавиатура
        keyboard_layout: "us"
        keyboard_variant: ""
        keyboard_options: ""
        
        # Консольный шрифт
        console_font: "Lat2-Terminus16"
        console_font_manage: true
        
        # Отладка и логирование
        debug_mode: true
        log_file: "/var/log/ansible-locale-changes.log"
        
        # Валидация
        validate_parameters: true
        strict_validation: true
        
        # Резервное копирование и откат
        backup_enabled: true
        enable_rollback: true
```

## Расширенная конфигурация

### Пользовательские переменные локали

```yaml
locale_variables:
  LANG: "{{ locale_primary }}"
  LANGUAGE: "{{ locale_primary | regex_replace('\\..*', '') }}"
  LC_ALL: "{{ locale_primary }}"
  LC_COLLATE: "{{ locale_primary }}"
  LC_CTYPE: "{{ locale_primary }}"
  LC_MESSAGES: "{{ locale_primary }}"
  LC_MONETARY: "{{ locale_primary }}"
  LC_NUMERIC: "{{ locale_primary }}"
  LC_TIME: "{{ locale_primary }}"
```

### Конфигурация пакетов Debian

```yaml
debian_packages:
  - locales
  - console-setup
  - keyboard-configuration
```

### Конфигурация команд обработчиков

```yaml
locale_reload_command: "locale-gen"
console_reload_command: "setupcon"
```

## Структура роли

```
roles/base/set_locale/
├── defaults/main.yml          # Переменные по умолчанию
├── handlers/main.yml          # Обработчики
├── meta/
│   ├── main.yml              # Метаданные роли
│   └── argument_specs.yml    # Спецификации валидации входных данных
├── tasks/
│   ├── main.yml              # Основные задачи роли
│   ├── preflight.yml         # Предварительные проверки
│   ├── validate.yml          # Валидация параметров
│   └── debian.yml            # Специфичные задачи для Debian/Ubuntu
├── README.md                 # Краткий обзор
├── README_eng.md            # Полная документация на английском
└── README_rus.md            # Полная документация на русском
```

## Поток выполнения задач

1. **Сбор системной информации**: Сбор системной информации
2. **Предварительные проверки**: Валидация версии Ansible, совместимости ОС, версии Python, дискового пространства
3. **Валидация параметров**: Валидация формата локали, формата часового пояса, раскладок клавиатуры, консольных шрифтов
4. **Создание резервных копий**: Создание резервных копий существующих файлов конфигурации
5. **Генерация основной локали**: Генерация основной локали
6. **Дополнительные локали**: Генерация дополнительных локалей для многоязычной поддержки
7. **Конфигурация переменных локали**: Настройка системных переменных окружения локализации
8. **Конфигурация часового пояса**: Установка системного часового пояса
9. **Задачи Debian/Ubuntu**: Выполнение специфичных задач конфигурации для Debian/Ubuntu
10. **Итоговая сводка**: Отображение комплексной сводки конфигурации

## Обработка ошибок

Роль реализует комплексную обработку ошибок:

- **Предварительные проверки**: Валидация версии Ansible, совместимости ОС, версии Python и дискового пространства
- **Валидация параметров**: Валидация формата локали, формата часового пояса, раскладок клавиатуры и консольных шрифтов
- **Паттерн Block-Rescue**: Использует структурированную обработку ошибок с автоматическим откатом
- **Резервное копирование и восстановление**: Создает резервные копии перед изменениями и восстанавливает при ошибках

## Поведение для Debian/Ubuntu

- Использует `apt` для управления пакетами
- Генерирует основную локаль с помощью `community.general.locale_gen`
- Настраивает `/etc/default/locale` и `/etc/locale.gen`
- Использует `debconf` для конфигурации клавиатуры
- Консольный шрифт в `/etc/default/console-setup`

## Паттерны валидации

Роль валидирует входные данные с помощью регулярных выражений:

- **Паттерн локали**: `^[a-z]{2}_[A-Z]{2}\.[A-Z0-9-]+$`
- **Паттерн часового пояса**: `^[A-Za-z0-9/_-]+$`
- **Раскладки клавиатуры**: Предопределенный список допустимых раскладок
- **Консольные шрифты**: Предопределенный список допустимых шрифтов

## Логирование

Роль реализует базовое логирование изменений конфигурации:

- Изменения конфигурации логируются в `/var/log/ansible-changes.log`
- Режим отладки предоставляет подробный вывод для диагностики проблем
- Простые сообщения об ошибках для неудачных операций

## Лицензия

MIT

## Автор

Mad-Axell [mad.axell@gmail.com]