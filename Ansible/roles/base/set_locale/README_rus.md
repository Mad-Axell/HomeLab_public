# base/set_locale

Роль конфигурации системной локали для Ansible.

## Описание

Эта роль Ansible обеспечивает комплексную настройку системной локализации для Linux систем, поддерживая семейства Debian/Ubuntu, RedHat/CentOS и SUSE. Роль обеспечивает правильную настройку локали, часового пояса, раскладки клавиатуры и консольного шрифта с расширенной валидацией, структурированным логированием и возможностями автоматического отката.

## Возможности

- **Кроссплатформенная поддержка**: Работает с семействами Debian, RedHat и SUSE
- **Комплексная валидация**: Предварительные проверки и валидация параметров
- **Структурированное логирование**: Логи в формате JSON для интеграции с агрегаторами логов
- **Автоматический откат**: Возможности резервного копирования и восстановления при ошибках
- **Двуязычная поддержка**: Документация на английском и русском языках
- **Режим отладки**: Подробный вывод для диагностики проблем
- **Идемпотентность**: Безопасно запускать несколько раз
- **Модульный дизайн**: OS-специфичные задачи для оптимальной совместимости
- **Сбор системной информации**: Автоматический сбор системной информации
- **Оптимизированная производительность**: Унифицированные обработчики и массовая установка пакетов
- **Модульные компоненты**: Переиспользуемые компоненты отладки и отката

## Требования

### Ansible
- **Минимальная версия**: 2.14+
- **Python**: 3.6+

### Поддерживаемые операционные системы

#### Семейство Debian
- Debian: 9, 10, 11, 12
- Ubuntu: 18.04, 20.04, 22.04, 24.04

#### Семейство RedHat
- RedHat Enterprise Linux: 7, 8, 9
- CentOS: 7, 8, 9
- Rocky Linux: 8, 9
- AlmaLinux: 8, 9

#### Семейство SUSE
- SUSE Linux Enterprise Server: Последние версии
- openSUSE: Последние версии

## Переменные роли

### Настройки отладки и резервного копирования

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `debug_mode` | bool | `true` | Включить подробный отладочный вывод |
| `backup_enabled` | bool | `true` | Включить резервное копирование файлов конфигурации |
| `backup_suffix` | str | `".backup"` | Суффикс для файлов резервных копий |

### Конфигурация часового пояса

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `timezone` | str | `"Europe/Moscow"` | Системный часовой пояс |
| `timezone_manage` | bool | `true` | Управлять ли конфигурацией часового пояса |

### Конфигурация локализации

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `locale_language` | str | `"en_US"` | Код основного языка локализации |
| `locale_encoding` | str | `"UTF-8"` | Кодировка локализации |
| `locale_primary` | str | `"{{ locale_language }}.{{ locale_encoding }}"` | Основная системная локализация |
| `locale_additional` | list | `["ru_RU.UTF-8", "en_GB.UTF-8"]` | Дополнительные локализации для генерации |
| `locale_variables` | dict | См. defaults | Системные переменные окружения локализации |

### Конфигурация консольного шрифта

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `console_font` | str | `"Lat2-Terminus16"` | Название консольного шрифта |
| `console_font_manage` | bool | `true` | Управлять ли конфигурацией консольного шрифта |

### Конфигурация клавиатуры

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `keyboard_layout` | str | `"us"` | Раскладка клавиатуры |
| `keyboard_variant` | str | `""` | Вариант клавиатуры |
| `keyboard_options` | str | `""` | Дополнительные опции клавиатуры |

### Настройки валидации

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `validate_parameters` | bool | `true` | Включить валидацию параметров |
| `strict_validation` | bool | `true` | Включить строгий режим валидации |

### Управление логированием и откатом

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `log_file` | str | `"/var/log/ansible-changes.log"` | Путь к файлу лога изменений |
| `enable_rollback` | bool | `true` | Автоматический откат при ошибке |

### Команды обработчиков

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `locale_reload_commands` | dict | См. defaults | OS-специфичные команды перезагрузки локали |
| `console_reload_commands` | dict | См. defaults | OS-специфичные команды перезагрузки консоли |

## Зависимости

Отсутствуют. Роль разработана как независимая и самодостаточная.

## Пример Playbook

```yaml
---
- name: Настройка системной локализации
  hosts: all
  become: yes
  roles:
    - role: base/set_locale
      vars:
        # Настройки локали
        locale_primary: "en_US.UTF-8"
        locale_additional:
          - "ru_RU.UTF-8"
          - "de_DE.UTF-8"
        
        # Часовой пояс
        timezone: "Europe/Moscow"
        timezone_manage: true
        
        # Клавиатура
        keyboard_layout: "us"
        keyboard_variant: ""
        keyboard_options: ""
        
        # Консольный шрифт
        console_font: "Lat2-Terminus16"
        console_font_manage: true
        
        # Отладка и логирование
        debug_mode: true
        log_file: "/var/log/ansible-locale-changes.log"
        
        # Валидация
        validate_parameters: true
        strict_validation: true
        
        # Резервное копирование и откат
        backup_enabled: true
        enable_rollback: true
```

## Расширенная конфигурация

### Пользовательские переменные локали

```yaml
locale_variables:
  LANG: "{{ locale_primary }}"
  LANGUAGE: "{{ locale_language }}"
  LC_ALL: "{{ locale_primary }}"
  LC_COLLATE: "{{ locale_primary }}"
  LC_CTYPE: "{{ locale_primary }}"
  LC_MESSAGES: "{{ locale_primary }}"
  LC_MONETARY: "{{ locale_primary }}"
  LC_NUMERIC: "{{ locale_primary }}"
  LC_TIME: "{{ locale_primary }}"
```

### OS-специфичный маппинг пакетов

```yaml
package_mappings:
  debian:
    locales: locales
    console_setup: console-setup
    keyboard_config: keyboard-configuration
    additional: []
  redhat:
    locales: glibc-locale-source
    console_setup: kbd
    keyboard_config: kbd
    additional:
      - glibc-langpack-en
  suse:
    locales: glibc-locale
    console_setup: kbd
    keyboard_config: kbd
    additional:
      - glibc-i18ndata
```

### Конфигурация команд обработчиков

```yaml
locale_reload_commands:
  Debian: "locale-gen"
  RedHat: "localectl set-locale LANG={{ locale_primary }}"
  Suse: "localectl set-locale LANG={{ locale_primary }}"

console_reload_commands:
  Debian: "setupcon"
  RedHat: "systemctl restart systemd-vconsole-setup"
  Suse: "systemctl restart systemd-vconsole-setup"
```

## Структура роли

```
roles/base/set_locale/
├── defaults/main.yml          # Переменные по умолчанию
├── handlers/main.yml          # Универсальные обработчики
├── meta/
│   ├── main.yml              # Метаданные роли
│   └── argument_specs.yml    # Спецификации валидации входных данных
├── tasks/
│   ├── main.yml              # Основные задачи роли
│   ├── preflight.yml         # Предварительные проверки
│   ├── validate.yml          # Валидация параметров
│   ├── debug.yml             # Общие debug-сообщения
│   ├── rollback.yml          # Общая логика отката
│   ├── debian.yml            # Специфичные задачи для Debian/Ubuntu
│   ├── redhat.yml            # Специфичные задачи для RedHat/CentOS
│   └── suse.yml              # Специфичные задачи для SUSE
├── README.md                 # Краткий обзор
├── README_eng.md            # Полная документация на английском
└── README_rus.md            # Полная документация на русском
```

## Поток выполнения задач

1. **Сбор системной информации**: Сбор системной информации
2. **Предварительные проверки**: Валидация версии Ansible, совместимости ОС, версии Python, дискового пространства
3. **Валидация параметров**: Валидация формата локали, формата часового пояса, раскладок клавиатуры, консольных шрифтов
4. **Создание резервных копий**: Создание резервных копий существующих файлов конфигурации
5. **Генерация основной локали**: Генерация основной локали
6. **Дополнительные локали**: Генерация дополнительных локалей для многоязычной поддержки
7. **Конфигурация переменных локали**: Настройка системных переменных окружения локализации
8. **Конфигурация часового пояса**: Установка системного часового пояса
9. **OS-специфичные задачи**: Выполнение OS-специфичных задач конфигурации
10. **Итоговая сводка**: Отображение комплексной сводки конфигурации

## Обработка ошибок

Роль реализует комплексную обработку ошибок:

- **Предварительные проверки**: Валидация версии Ansible, совместимости ОС, версии Python и дискового пространства
- **Валидация параметров**: Валидация формата локали, формата часового пояса, раскладок клавиатуры и консольных шрифтов
- **Паттерн Block-Rescue**: Использует структурированную обработку ошибок с автоматическим откатом
- **Резервное копирование и восстановление**: Создает резервные копии перед изменениями и восстанавливает при ошибках

## OS-специфичное поведение

### Debian/Ubuntu
- Использует `apt` для управления пакетами
- Генерирует основную локаль с помощью `community.general.locale_gen`
- Настраивает `/etc/default/locale` и `/etc/locale.gen`
- Использует `debconf` для конфигурации клавиатуры
- Консольный шрифт в `/etc/default/console-setup`

### RedHat/CentOS
- Использует `yum`/`dnf` для управления пакетами
- Использует `localectl` для конфигурации локали и клавиатуры
- Консольный шрифт в `/etc/vconsole.conf`

### SUSE
- Использует `zypper` для управления пакетами
- Использует `localectl` для конфигурации локали и клавиатуры
- Консольный шрифт в `/etc/vconsole.conf`

## Паттерны валидации

Роль валидирует входные данные с помощью регулярных выражений:

- **Паттерн локали**: `^[a-z]{2}_[A-Z]{2}\.[A-Z0-9-]+$`
- **Паттерн часового пояса**: `^[A-Za-z0-9/_-]+$`
- **Раскладки клавиатуры**: Предопределенный список допустимых раскладок
- **Консольные шрифты**: Предопределенный список допустимых шрифтов

## Структурированное логирование

Роль реализует комплексное структурированное логирование в формате JSON:

```json
{
  "timestamp": "2024-01-15T10:30:45.123456Z",
  "level": "INFO",
  "event_type": "LOCALE_CONFIGURATION",
  "user": "ansible_user",
  "host": "target_host",
  "playbook": "locale_setup",
  "correlation_id": 1705312245,
  "message": "Locale configuration applied",
  "metadata": {
    "locale_primary": "en_US.UTF-8",
    "timezone": "Europe/Moscow",
    "keyboard_layout": "us",
    "console_font": "Lat2-Terminus16",
    "os_family": "Debian",
    "os_version": "12"
  }
}
```

## Лицензия

MIT

## Автор

Mad-Axell [mad.axell@gmail.com]