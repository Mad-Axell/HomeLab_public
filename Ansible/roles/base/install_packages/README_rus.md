# install_packages - Роль установки пакетов Debian

## Описание

Эта роль устанавливает основные пакеты на системах Debian/Ubuntu с комплексной валидацией, расширенными возможностями отладки и обработкой ошибок готовой для продакшена. Поддерживает как основные, так и дополнительные пакеты, конфигурацию автоматических обновлений безопасности и включает структурированное логирование для всех операций.

## Возможности

- **Универсальное управление пакетами**: Устанавливает основные пакеты для систем Debian/Ubuntu
- **Автоматические обновления безопасности**: Настраивает unattended-upgrades для обновлений безопасности
- **Комплексная валидация**: Предварительные проверки и проверка пост-развертывания
- **Структурированное логирование**: Логи в формате JSON для всех операций
- **Обработка ошибок**: Паттерны block-rescue с возможностями отката
- **Поддержка отладки**: Подробный вывод отладки с системными метриками
- **Мониторинг производительности**: Отслеживание времени выполнения и метрики производительности

## Поддерживаемые платформы

- **Ubuntu**: focal, jammy, noble
- **Debian**: bullseye, bookworm, trixie

## Требования

- Ansible 2.9 или выше
- Операционные системы семейства Debian
- Права root или sudo
- Сетевое подключение для загрузки пакетов

## Переменные роли

### Основная конфигурация

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `debug_mode` | bool | `false` | Включить подробный вывод отладки |
| `log_file` | str | `"/var/log/ansible-changes.log"` | Путь к файлу структурированного лога |
| `validate_parameters` | bool | `true` | Включить валидацию параметров |
| `verify_deployment` | bool | `true` | Включить проверку пост-развертывания |

### Управление пакетами

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `package_cache_valid_time` | int | `86400` | Время валидности кэша пакетов в секундах (24 часа) |
| `package_update_cache` | bool | `true` | Обновлять кэш пакетов перед операциями |
| `package_upgrade_packages` | bool | `true` | Обновлять системные пакеты до последних версий |
| `package_install_recommends` | bool | `true` | Устанавливать рекомендуемые пакеты вместе с основными |

### Основные пакеты

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `essential_packages` | list | См. ниже | Список основных пакетов для установки |

**Основные пакеты по умолчанию:**
- `acl` - Списки контроля доступа
- `sudo` - Выполнение от имени суперпользователя
- `net-tools` - Сетевые утилиты
- `gnupg` - GNU Privacy Guard
- `htop` - Интерактивный просмотрщик процессов
- `curl` - Инструмент командной строки для передачи данных
- `wget` - Загрузчик файлов из интернета
- `openssh-client` - SSH клиент
- `iputils-ping` - Инструменты тестирования сети
- `dnsutils` - DNS утилиты
- `apt-transport-https` - HTTPS транспорт для APT
- `software-properties-common` - Управление свойствами ПО

### Дополнительные пакеты

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `optional_packages` | list | `[]` | Список дополнительных пакетов для установки |

### Автоматические обновления безопасности

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `autoupdates_enabled` | bool | `false` | Включить автоматические обновления безопасности |
| `security_updates_only` | bool | `true` | Устанавливать только обновления безопасности |
| `reboot_if_required` | bool | `false` | Разрешить автоматическую перезагрузку системы при необходимости |
| `gpg_require_signed` | bool | `true` | Требовать проверку GPG подписи |
| `autoupdates_autoremove` | bool | `true` | Автоматическое удаление неиспользуемых зависимостей |
| `autoupdates_schedule_enabled` | bool | `true` | Включить расписание автоматических обновлений |
| `autoupdates_time` | str | `"02:00"` | Время для автоматических обновлений |
| `autoupdates_download_only` | bool | `false` | Загружать обновления без установки |

### Системные требования

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `min_disk_space` | int | `1073741824` | Минимальное дисковое пространство в байтах (1ГБ) |
| `min_memory_mb` | int | `512` | Минимальная память в МБ |
| `required_mounts` | list | `["/"]` | Необходимые точки монтирования для предварительных проверок |

## Зависимости

Отсутствуют

## Пример плейбука

### Базовое использование

```yaml
---
- hosts: all
  become: true
  roles:
    - role: install_packages
      vars:
        debug_mode: true
        essential_packages:
          - acl
          - sudo
          - curl
          - wget
```

### С дополнительными пакетами

```yaml
---
- hosts: all
  become: true
  roles:
    - role: install_packages
      vars:
        essential_packages:
          - acl
          - sudo
          - curl
        optional_packages:
          - vim
          - git
          - htop
        debug_mode: true
```

### С автоматическими обновлениями безопасности

```yaml
---
- hosts: all
  become: true
  roles:
    - role: install_packages
      vars:
        autoupdates_enabled: true
        security_updates_only: true
        reboot_if_required: false
        autoupdates_time: "03:00"
```

## Структура роли

```
roles/base/install_packages/
├── defaults/main.yml              # Переменные по умолчанию
├── handlers/main.yml              # Обработчики перезапуска сервисов
├── meta/
│   ├── main.yml                   # Метаданные роли
│   └── argument_specs.yml         # Спецификации валидации входных данных
├── tasks/
│   ├── main.yml                   # Основная оркестрация
│   ├── validate.yml               # Валидация параметров
│   ├── preflight.yml              # Предварительные проверки
│   ├── debian.yml                 # Специфичные для Debian/Ubuntu задачи
│   ├── autoupdate_debian.yml      # Конфигурация автоматических обновлений
│   └── verify.yml                 # Проверка пост-развертывания
├── templates/
│   ├── 20auto-upgrades.j2         # Конфигурация APT periodic
│   └── 50unattended-upgrades.j2   # Конфигурация unattended upgrades
├── README.md                      # Краткий обзор
├── README_eng.md                  # Полная документация на английском
└── README_rus.md                  # Полная документация на русском
```

## Поток выполнения задач

1. **Валидация**: Валидация аргументов и параметров роли
2. **Предварительные проверки**: Проверка совместимости системы и ресурсов
3. **Управление кэшем пакетов**: Обновление кэша APT если включено
4. **Обновление системы**: Обновление пакетов если включено
5. **Установка основных пакетов**: Установка необходимых пакетов
6. **Установка дополнительных пакетов**: Установка дополнительных пакетов если определены
7. **Проверка**: Проверка корректной установки всех пакетов
8. **Конфигурация автоматических обновлений**: Настройка обновлений безопасности если включено

## Предварительные проверки

Роль выполняет комплексные предварительные проверки:

- Валидация версии Ansible (2.9+)
- Проверка совместимости ОС (только семейство Debian)
- Проверка дискового пространства
- Проверка требований к памяти
- Тест сетевого подключения
- Проверка доступности менеджера пакетов
- Проверка существования необходимых директорий
- Проверка возможности записи в файловую систему

## Структурированное логирование

Все операции логируются в структурированный JSON файл (`/var/log/ansible-changes.log` по умолчанию) со следующей информацией:

- Временная метка и идентификатор корреляции
- Тип события и уровень
- Информация о пользователе и хосте
- Метаданные операции
- Статус успеха/неудачи

## Обработка ошибок

Роль реализует комплексную обработку ошибок:

- Паттерны block-rescue для критических операций
- Автоматический откат при сбоях конфигурации
- Подробные сообщения об ошибках с контекстом
- Graceful degradation для некритических сбоев

## Возможности производительности

- Настраиваемая валидность кэша пакетов
- Механизмы повтора для неудачных операций
- Отслеживание времени выполнения
- Мониторинг использования ресурсов
- Оптимизированные операции APT

## Возможности безопасности

- Проверка GPG подписи для пакетов
- Безопасные права доступа к файлам конфигурации
- Отсутствие захардкоженных секретов
- Валидация и санитизация входных данных
- Аудит через структурированное логирование

## Устранение неполадок

### Частые проблемы

1. **Сбои установки пакетов**
   - Проверить сетевое подключение
   - Убедиться в корректности имен пакетов
   - Проверить достаточность дискового пространства

2. **Ошибки прав доступа**
   - Запустить плейбук с `become: true`
   - Проверить конфигурацию sudo
   - Убедиться в наличии необходимых привилегий

3. **Сбои валидации**
   - Проверить типы и значения параметров
   - Убедиться в определении всех необходимых переменных
   - Проверить совместимость ОС

### Режим отладки

Включить режим отладки для подробного вывода:

```yaml
- role: install_packages
  vars:
    debug_mode: true
```

Это предоставит:
- Подробную системную информацию
- Анализ доступности пакетов
- Отслеживание прогресса установки
- Метрики производительности
- Подробные детали ошибок

## Лицензия

MIT

## Автор

Системный администратор [mad.axell@gmail.com]
