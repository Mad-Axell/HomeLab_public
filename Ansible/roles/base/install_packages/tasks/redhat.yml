---
# =============================================================================
# RedHat/CentOS Specific Package Installation Tasks
# =============================================================================
# This file contains RedHat/CentOS specific package installation tasks
# for YUM/DNF package manager.
#
# Этот файл содержит специфичные для RedHat/CentOS задачи установки пакетов
# для менеджера пакетов YUM/DNF.
# =============================================================================

# Execute YUM/DNF package cache management and repository synchronization
# Выполнение управления кэшем пакетов YUM/DNF и синхронизации репозиториев
- name: "Execute YUM/DNF package cache management and repository synchronization"
  block:
    - name: "Update YUM/DNF package cache"
      # Refresh package repository information / Обновление информации о репозиториях пакетов
      ansible.builtin.yum:
        update_cache: "{{ package_update_cache }}"
      register: yum_update_result
      when: package_update_cache | bool

    - name: "Clean expired YUM/DNF cache"
      # Clean expired cache to free up space / Очистка устаревшего кэша для освобождения места
      ansible.builtin.yum:
        clean: "expire-cache"
      register: yum_clean_result
      when: package_clean_expire_cache | bool

    - name: "Check available YUM/DNF repositories"
      # Verify repository availability / Проверка доступности репозиториев
      ansible.builtin.command: yum repolist
      register: yum_repositories
      failed_when: false
      changed_when: false
      when: debug_mode | bool

    - name: "Display YUM/DNF cache update and repository analysis results (English)"
      # Show detailed cache update status and repository information / Показать детальный статус обновления кэша и информацию о репозиториях
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "YUM/DNF Cache Update and Repository Analysis Results:"
          - "============================================================================="
          - "Cache Updated:            {{ yum_update_result.changed | default(false) }}"
          - "Cache Cleaned:            {{ yum_clean_result.changed | default(false) }}"
          - "Update Cache Enabled:     {{ package_update_cache }}"
          - "Clean Expire Cache:       {{ package_clean_expire_cache }}"
          - "Available Repositories:   {{ yum_repositories.stdout_lines | length if yum_repositories is defined else 'Unknown' }}"
          - "Operation Status:         {{ 'SUCCESS' if (yum_update_result.changed or yum_clean_result.changed) else 'NO CHANGE' }}"
          - "============================================================================="
      when: 
        - debug_mode | bool and (package_update_cache | bool or package_clean_expire_cache | bool)
        - debug_lang | default('both') in ['english', 'both']

    - name: "Display YUM/DNF cache update and repository analysis results (Russian)"
      # Show detailed cache update status and repository information / Показать детальный статус обновления кэша и информацию о репозиториях
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "Результаты обновления кэша YUM/DNF и анализа репозиториев:"
          - "============================================================================="
          - "Кэш обновлен:             {{ yum_update_result.changed | default(false) }}"
          - "Кэш очищен:               {{ yum_clean_result.changed | default(false) }}"
          - "Обновление кэша включено: {{ package_update_cache }}"
          - "Очистка устаревшего кэша: {{ package_clean_expire_cache }}"
          - "Доступные репозитории:    {{ yum_repositories.stdout_lines | length if yum_repositories is defined else 'Неизвестно' }}"
          - "Статус операции:          {{ 'УСПЕХ' if (yum_update_result.changed or yum_clean_result.changed) else 'БЕЗ ИЗМЕНЕНИЙ' }}"
          - "============================================================================="
      when: 
        - debug_mode | bool and (package_update_cache | bool or package_clean_expire_cache | bool)
        - debug_lang | default('both') in ['russian', 'both']

# Execute comprehensive system package upgrade and maintenance for RedHat/CentOS
# Выполнение комплексного обновления и обслуживания системных пакетов для RedHat/CentOS
- name: "Execute system package upgrade and maintenance for RedHat/CentOS"
  block:
    - name: "Perform system-wide package upgrade to latest available versions"
      # Update installed packages to latest versions with configurable upgrade policy / Обновление установленных пакетов до последних версий с настраиваемой политикой обновления
      ansible.builtin.yum:
        name: "*"
        state: latest
      register: yum_upgrade_result
      when: package_upgrade_packages | bool

    - name: "Display system package upgrade operation results (English)"
      # Show comprehensive upgrade operation status and impact / Показать комплексный статус операции обновления и её влияние
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "System Package Upgrade Operation Results:"
          - "============================================================================="
          - "Packages Upgraded:        {{ yum_upgrade_result.changed | default(false) }}"
          - "Upgrade Policy Enabled:   {{ package_upgrade_packages }}"
          - "Operation Status:         {{ 'SUCCESS' if yum_upgrade_result.changed else 'NO CHANGE' }}"
          - "Upgrade Completed:        YES"
          - "============================================================================="
      when: 
        - debug_mode | bool and package_upgrade_packages | bool
        - debug_lang | default('both') in ['english', 'both']

    - name: "Display system package upgrade operation results (Russian)"
      # Show comprehensive upgrade operation status and impact / Показать комплексный статус операции обновления и её влияние
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "Результаты операции обновления системных пакетов:"
          - "============================================================================="
          - "Пакеты обновлены:         {{ yum_upgrade_result.changed | default(false) }}"
          - "Политика обновления включена: {{ package_upgrade_packages }}"
          - "Статус операции:          {{ 'УСПЕХ' if yum_upgrade_result.changed else 'БЕЗ ИЗМЕНЕНИЙ' }}"
          - "Обновление завершено:     ДА"
          - "============================================================================="
      when: 
        - debug_mode | bool and package_upgrade_packages | bool
        - debug_lang | default('both') in ['russian', 'both']

# Execute essential package installation with comprehensive pre-installation analysis for RedHat/CentOS
# Выполнение установки основных пакетов с комплексным предустановочным анализом для RedHat/CentOS
- name: "Execute essential package installation with pre-installation analysis for RedHat/CentOS"
  block:
    - name: "Gather comprehensive information about currently installed packages"
      # Collect detailed package information for installation planning / Сбор детальной информации о пакетах для планирования установки
      ansible.builtin.package_facts:
        manager: auto
      register: package_facts

    - name: "Perform detailed package availability verification in repositories"
      # Verify packages are available for installation with version information / Проверка доступности пакетов для установки с информацией о версиях
      ansible.builtin.command: "yum list available {{ item }}"
      register: package_availability
      failed_when: false
      changed_when: false
      loop: "{{ platform_packages }}"
      when: debug_mode | bool

    - name: "Display package availability analysis results (English)"
      # Show detailed package availability information including versions / Показать детальную информацию о доступности пакетов включая версии
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "Package Availability Analysis:"
          - "============================================================================="
          - "Package Name:             {{ item.item }}"
          - "Available in Repos:       {{ 'YES' if item.rc == 0 else 'NO' }}"
          - "Status:                   {{ 'AVAILABLE' if item.rc == 0 else 'NOT FOUND' }}"
          - "============================================================================="
      loop: "{{ package_availability.results | default([]) }}"
      when: 
        - debug_mode | bool and package_availability is defined
        - debug_lang | default('both') in ['english', 'both']

    - name: "Display package availability analysis results (Russian)"
      # Show detailed package availability information including versions / Показать детальную информацию о доступности пакетов включая версии
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "Анализ доступности пакетов:"
          - "============================================================================="
          - "Имя пакета:               {{ item.item }}"
          - "Доступен в репозиториях:  {{ 'ДА' if item.rc == 0 else 'НЕТ' }}"
          - "Статус:                   {{ 'ДОСТУПЕН' if item.rc == 0 else 'НЕ НАЙДЕН' }}"
          - "============================================================================="
      loop: "{{ package_availability.results | default([]) }}"
      when: 
        - debug_mode | bool and package_availability is defined
        - debug_lang | default('both') in ['russian', 'both']

    - name: "Display current package installation status and installation plan (English)"
      # Show comprehensive package installation status and planning information / Показать комплексный статус установки пакетов и информацию о планировании
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "Current Package Installation Status and Installation Plan:"
          - "============================================================================="
          - "Total Installed Packages:  {{ package_facts.ansible_facts.packages | length }}"
          - "Essential Already Installed: {{ platform_packages | intersect(package_facts.ansible_facts.packages.keys()) | list }}"
          - "Essential To Install:      {{ platform_packages | difference(package_facts.ansible_facts.packages.keys()) | list }}"
          - "Installation Plan Status:  {{ 'READY' if (platform_packages | difference(package_facts.ansible_facts.packages.keys()) | list | length) > 0 else 'ALL INSTALLED' }}"
          - "============================================================================="
      when: 
        - debug_mode | bool
        - debug_lang | default('both') in ['english', 'both']
      no_log: true

    - name: "Display current package installation status and installation plan (Russian)"
      # Show comprehensive package installation status and planning information / Показать комплексный статус установки пакетов и информацию о планировании
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "Текущий статус установки пакетов и план установки:"
          - "============================================================================="
          - "Всего установленных пакетов: {{ package_facts.ansible_facts.packages | length }}"
          - "Основные уже установлены:    {{ platform_packages | intersect(package_facts.ansible_facts.packages.keys()) | list }}"
          - "Основные к установке:        {{ platform_packages | difference(package_facts.ansible_facts.packages.keys()) | list }}"
          - "Статус плана установки:      {{ 'ГОТОВ' if (platform_packages | difference(package_facts.ansible_facts.packages.keys()) | list | length) > 0 else 'ВСЕ УСТАНОВЛЕНЫ' }}"
          - "============================================================================="
      when: 
        - debug_mode | bool
        - debug_lang | default('both') in ['russian', 'both']
      no_log: true

    - name: "Execute essential packages installation with retry mechanism and error handling"
      # Install required packages with retry mechanism and comprehensive error handling / Установка необходимых пакетов с механизмом повтора и комплексной обработкой ошибок
      ansible.builtin.yum:
        name: "{{ platform_packages }}"
        state: present
      register: essential_packages_result
      retries: 3
      delay: 10
      until: essential_packages_result is succeeded
      notify: "Restart system services after package installation for RedHat"

    - name: "Display essential packages installation operation results (English)"
      # Show detailed installation operation results including success and failure analysis / Показать детальные результаты операции установки включая анализ успеха и сбоев
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "Essential Packages Installation Operation Results:"
          - "============================================================================="
          - "Packages Changed:          {{ essential_packages_result.changed | default(false) }}"
          - "Packages Installed:        {{ essential_packages_result.results | selectattr('changed') | map(attribute='item') | list if essential_packages_result.results is defined else 'N/A' }}"
          - "Failed Packages:           {{ essential_packages_result.results | selectattr('failed') | map(attribute='item') | list if essential_packages_result.results is defined else 'None' }}"
          - "Operation Status:          {{ 'SUCCESS' if essential_packages_result.changed else 'NO CHANGE' }}"
          - "Installation Completed:    YES"
          - "============================================================================="
      when: 
        - debug_mode | bool
        - debug_lang | default('both') in ['english', 'both']
      no_log: true

    - name: "Display essential packages installation operation results (Russian)"
      # Show detailed installation operation results including success and failure analysis / Показать детальные результаты операции установки включая анализ успеха и сбоев
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "Результаты операции установки основных пакетов:"
          - "============================================================================="
          - "Пакеты изменены:           {{ essential_packages_result.changed | default(false) }}"
          - "Пакеты установлены:        {{ essential_packages_result.results | selectattr('changed') | map(attribute='item') | list if essential_packages_result.results is defined else 'Н/Д' }}"
          - "Неудачные пакеты:          {{ essential_packages_result.results | selectattr('failed') | map(attribute='item') | list if essential_packages_result.results is defined else 'Нет' }}"
          - "Статус операции:           {{ 'УСПЕХ' if essential_packages_result.changed else 'БЕЗ ИЗМЕНЕНИЙ' }}"
          - "Установка завершена:       ДА"
          - "============================================================================="
      when: 
        - debug_mode | bool
        - debug_lang | default('both') in ['russian', 'both']
      no_log: true

# Execute optional packages installation with conditional processing and comprehensive error handling for RedHat/CentOS
# Выполнение установки дополнительных пакетов с условной обработкой и комплексной обработкой ошибок для RedHat/CentOS
- name: "Execute optional packages installation with conditional processing for RedHat/CentOS"
  block:
    - name: "Execute user-defined optional packages installation with retry mechanism"
      # Install user-defined optional packages with retry mechanism and comprehensive error handling / Установка пользовательских дополнительных пакетов с механизмом повтора и комплексной обработкой ошибок
      ansible.builtin.yum:
        name: "{{ platform_optional_packages }}"
        state: present
      register: optional_packages_result
      retries: 3
      delay: 10
      until: optional_packages_result is succeeded
      when: platform_optional_packages | length > 0

    - name: "Display optional packages installation operation results (English)"
      # Show detailed optional packages installation status and operation analysis / Показать детальный статус установки дополнительных пакетов и анализ операции
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "Optional Packages Installation Operation Results:"
          - "============================================================================="
          - "Packages Changed:          {{ optional_packages_result.changed | default(false) }}"
          - "Packages Installed:        {{ optional_packages_result.results | selectattr('changed') | map(attribute='item') | list if optional_packages_result.results is defined else 'N/A' }}"
          - "Failed Packages:           {{ optional_packages_result.results | selectattr('failed') | map(attribute='item') | list if optional_packages_result.results is defined else 'None' }}"
          - "Operation Status:          {{ 'SUCCESS' if optional_packages_result.changed else 'NO CHANGE' }}"
          - "Installation Completed:    YES"
          - "============================================================================="
      when: 
        - debug_mode | bool and platform_optional_packages | length > 0
        - debug_lang | default('both') in ['english', 'both']
      no_log: true

    - name: "Display optional packages installation operation results (Russian)"
      # Show detailed optional packages installation status and operation analysis / Показать детальный статус установки дополнительных пакетов и анализ операции
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "Результаты операции установки дополнительных пакетов:"
          - "============================================================================="
          - "Пакеты изменены:           {{ optional_packages_result.changed | default(false) }}"
          - "Пакеты установлены:        {{ optional_packages_result.results | selectattr('changed') | map(attribute='item') | list if optional_packages_result.results is defined else 'Н/Д' }}"
          - "Неудачные пакеты:          {{ optional_packages_result.results | selectattr('failed') | map(attribute='item') | list if optional_packages_result.results is defined else 'Нет' }}"
          - "Статус операции:           {{ 'УСПЕХ' if optional_packages_result.changed else 'БЕЗ ИЗМЕНЕНИЙ' }}"
          - "Установка завершена:       ДА"
          - "============================================================================="
      when: 
        - debug_mode | bool and platform_optional_packages | length > 0
        - debug_lang | default('both') in ['russian', 'both']
      no_log: true

# Execute comprehensive package installation verification and post-installation validation for RedHat/CentOS
# Выполнение комплексной проверки установки пакетов и пост-установочной валидации для RedHat/CentOS
- name: "Execute package installation verification and post-installation validation for RedHat/CentOS"
  block:
    - name: "Gather final comprehensive package information for post-installation verification"
      # Collect final package information for comprehensive verification / Сбор финальной информации о пакетах для комплексной проверки
      ansible.builtin.package_facts:
        manager: auto
      register: final_package_facts

    - name: "Perform comprehensive verification of all essential packages installation"
      # Verify each essential package is present and properly installed / Проверка присутствия и корректной установки каждого основного пакета
      ansible.builtin.assert:
        that:
          - item in final_package_facts.ansible_facts.packages
        fail_msg: "Package '{{ item }}' was not successfully installed"
        success_msg: "Package '{{ item }}' is installed and verified"
      loop: "{{ platform_packages }}"

    - name: "Display final installation summary and verification results (English)"
      # Show comprehensive installation results and verification status / Показать комплексные результаты установки и статус проверки
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "Final Installation Summary and Verification Results:"
          - "============================================================================="
          - "Essential Packages Installed: {{ platform_packages | length }}"
          - "Optional Packages Installed:  {{ platform_optional_packages | length if platform_optional_packages is defined else 0 }}"
          - "Total Packages in System:     {{ final_package_facts.ansible_facts.packages | length }}"
          - "All Essential Verified:       YES"
          - "Verification Status:          SUCCESS"
          - "System Ready for Use:         YES"
          - "============================================================================="
      when: 
        - debug_mode | bool
        - debug_lang | default('both') in ['english', 'both']

    - name: "Display final installation summary and verification results (Russian)"
      # Show comprehensive installation results and verification status / Показать комплексные результаты установки и статус проверки
      ansible.builtin.debug:
        msg:
          - "============================================================================="
          - "Финальная сводка установки и результаты проверки:"
          - "============================================================================="
          - "Основные пакеты установлены:  {{ platform_packages | length }}"
          - "Дополнительные пакеты установлены: {{ platform_optional_packages | length if platform_optional_packages is defined else 0 }}"
          - "Всего пакетов в системе:      {{ final_package_facts.ansible_facts.packages | length }}"
          - "Все основные проверены:       ДА"
          - "Статус проверки:             УСПЕХ"
          - "Система готова к использованию: ДА"
          - "============================================================================="
      when: 
        - debug_mode | bool
        - debug_lang | default('both') in ['russian', 'both']

  rescue:
    - name: "Handle RedHat/CentOS package installation errors"
      # Handle any errors that occur during package installation / Обработка любых ошибок, возникающих при установке пакетов
      ansible.builtin.fail:
        msg: "Failed to install packages on RedHat/CentOS system. Check package availability and system state."
