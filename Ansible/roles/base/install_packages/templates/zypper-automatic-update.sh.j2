#!/bin/bash
# Automatic Security Updates Script for SUSE/openSUSE
# Скрипт автоматических обновлений безопасности для SUSE/openSUSE
# Managed by Ansible - DO NOT EDIT MANUALLY
# Управляется Ansible - НЕ РЕДАКТИРУЙТЕ ВРУЧНУЮ

set -euo pipefail

# Logging / Логирование
LOG_FILE="/var/log/zypper-automatic-update.log"
exec > >(tee -a "$LOG_FILE")
exec 2>&1

echo "====================================================================="
echo "Zypper Automatic Security Updates - $(date)"
echo "====================================================================="

# Refresh repositories / Обновить репозитории
echo "Refreshing repositories..."
zypper --non-interactive --gpg-auto-import-keys refresh

{% if security_updates_only | bool %}
# List available security patches / Список доступных патчей безопасности
echo "Checking for security patches..."
PATCHES=$(zypper --non-interactive list-patches --category security 2>/dev/null | grep -c "^security" || echo "0")
echo "Available security patches: $PATCHES"

if [ "$PATCHES" -gt 0 ]; then
    echo "Installing security patches..."
    {% if autoupdates_download_only | bool %}
    # Download only / Только загрузка
    zypper --non-interactive patch-check --category security --download-only
    echo "Security patches downloaded but not installed (download-only mode)"
    {% else %}
    # Install security patches / Установить патчи безопасности
    zypper --non-interactive patch --category security --auto-agree-with-licenses
    echo "Security patches installed successfully"
    {% endif %}
else
    echo "No security patches available"
fi
{% else %}
# Update all packages / Обновить все пакеты
echo "Checking for available updates..."
{% if autoupdates_download_only | bool %}
# Download only / Только загрузка
zypper --non-interactive update --download-only
echo "Updates downloaded but not installed (download-only mode)"
{% else %}
# Install all updates / Установить все обновления
zypper --non-interactive update --auto-agree-with-licenses
echo "All updates installed successfully"
{% endif %}
{% endif %}

# Clean up old packages / Очистка старых пакетов
echo "Cleaning up old packages..."
zypper --non-interactive clean --all

# Check if reboot is required / Проверка необходимости перезагрузки
if [ -f /usr/sbin/zypper-needs-restarting ]; then
    NEEDS_REBOOT=$(zypper-needs-restarting -r 2>/dev/null && echo "no" || echo "yes")
    
    if [ "$NEEDS_REBOOT" = "yes" ]; then
        echo "System reboot is required to complete updates"
        {% if reboot_if_required | bool %}
        echo "Automatic reboot enabled - scheduling reboot in 2 minutes..."
        shutdown -r +2 "System reboot required for security updates"
        {% else %}
        echo "Automatic reboot disabled - manual reboot required"
        {% endif %}
    else
        echo "No system reboot required"
    fi
else
    echo "zypper-needs-restarting not available - cannot check reboot status"
fi

echo "====================================================================="
echo "Automatic updates completed - $(date)"
echo "====================================================================="

