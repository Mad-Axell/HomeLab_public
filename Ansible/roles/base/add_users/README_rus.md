# base.add_users - Полная русская документация

## Обзор роли

Роль `base.add_users` предназначена для комплексного управления пользователями в Linux системах с расширенной конфигурацией безопасности, управлением группами и настройкой sudo привилегий. Данная роль поддерживает различные Linux дистрибутивы и предоставляет обширные возможности усиления безопасности.

## Возможности

### Основная функциональность
- **Управление пользователями**: Создание и обновление учетных записей пользователей с настраиваемыми параметрами
- **Управление группами**: Автоматическое создание групп и назначение членства
- **Конфигурация sudo**: Гранулярные sudo привилегии с группами безопасности
- **Усиление безопасности**: Конфигурация PAM, политики паролей и безопасность аккаунтов
- **Кроссплатформенность**: Ubuntu, Debian, RHEL/CentOS и openSUSE
- **Многоязычность**: Отладочный вывод на английском и русском языках

### Функции безопасности
- **Политики паролей**: Настраиваемые требования к надежности паролей
- **Блокировка аккаунтов**: Автоматическая блокировка неактивных пользователей
- **История паролей**: Предотвращение повторного использования паролей
- **Интеграция PAM**: Конфигурация PAM для конкретных ОС для усиления безопасности
- **Безопасные права**: Правильные права на файлы и директории

### Расширенные возможности
- **Группы безопасности**: Контроль доступа на основе ролей с гранулярными разрешениями
- **Структурированное логирование**: Комплексное логирование операций с корреляционными ID
- **Обработка ошибок**: Graceful degradation и автоматический откат
- **Валидация**: Обширная валидация входных данных и предварительные проверки
- **Производительность**: Оптимизированное выполнение с механизмами повторов

## Требования

### Системные требования
- **Ansible**: Версия 2.14 или выше
- **Python**: Версия 3.8 или выше
- **Операционные системы**: Ubuntu 20.04+, Debian 11+, RHEL 8+, openSUSE 15+
- **Привилегии**: Требуется root доступ для управления пользователями

### Зависимости
- **Модули Ansible**: user, group, file, lineinfile, template, systemd
- **Системные пакеты**: sudo, passwd, libpam-pwquality, libpam-modules
- **Утилиты**: visudo, chage, useradd, usermod

## Переменные роли

### Основная конфигурация

```yaml
# Управление пользователями
users_to_add: []                    # Список. Пользователи для создания или обновления
  - username: "user_name"           # Строка. Имя пользователя (обязательно)
    password: "secure_password"      # Строка. Пароль открытым текстом (обязательно)
    groups: ["group1", "group2"]    # Список. Группы пользователя
    is_sudoers: true                # Логическое значение. Предоставить sudo привилегии
    shell: "/bin/bash"              # Строка. Оболочка пользователя
    uid: 1001                       # Целое число. ID пользователя (опционально)
    gid: 1001                       # Целое число. ID группы (опционально)
    create_home: true               # Логическое значение. Создать домашнюю директорию
    home: "/home/user_name"         # Строка. Путь домашней директории

# Конфигурация отладки
debug_mode: false                   # Логическое значение. Включить детальный вывод отладки
debug_lang: 'both'                  # Строка. Язык отладки: english/russian/both
debug_show_passwords: false         # Логическое значение. Показывать пароли в отладке (НЕБЕЗОПАСНО)
```

### Конфигурация безопасности

```yaml
# Политики паролей
add_users_validate_passwords: true     # Логическое значение. Включить валидацию паролей
add_users_min_password_length: 8     # Целое число. Минимальная длина пароля
password_max_age: 90                 # Целое число. Максимальный возраст пароля в днях
password_warn_age: 14                # Целое число. Предупреждение о смене пароля за N дней
account_inactive_days: 30            # Целое число. Дней до блокировки аккаунта
pam_deny_attempts: 3                 # Целое число. Неудачных попыток входа до блокировки
pam_unlock_time: 900                 # Целое число. Время разблокировки аккаунта в секундах
password_remember_count: 12          # Целое число. Количество старых паролей для запоминания

# Права на файлы
umask_system_users: '0027'           # Строка. Umask для системных пользователей
home_dir_permissions: '0750'         # Строка. Права на домашние директории
```

### Конфигурация групп безопасности

```yaml
security_groups:
  admins:                            # Полный административный доступ
    members: ["admin1", "admin2"]
    commands: ["ALL"]
    nopasswd: true
  operators:                         # Ограниченный операционный доступ
    members: ["op1", "op2"]
    commands:
      - "/bin/systemctl restart *"
      - "/bin/systemctl stop *"
    nopasswd: false
  auditors:                          # Доступ только на чтение для аудита
    members: ["audit1"]
    commands:
      - "/bin/cat /var/log/*"
      - "/bin/journalctl *"
    nopasswd: true
```

### Конфигурация производительности

```yaml
# Откат и резервное копирование
enable_rollback: true                # Логическое значение. Включить автоматический откат при ошибке
backup_config: true                  # Логическое значение. Создавать резервную копию перед изменениями

# Настройка производительности
retries: 3                           # Целое число. Количество повторов для неудачных задач
retry_delay: 5                       # Целое число. Задержка между повторами в секундах
```

## Примеры использования

### Базовое создание пользователей

```yaml
- hosts: servers
  roles:
    - role: base.add_users
      vars:
        users_to_add:
          - username: "john"
            password: "SecurePass123"
            groups: ["docker", "wheel"]
            is_sudoers: true
```

### Расширенная конфигурация

```yaml
- hosts: servers
  roles:
    - role: base.add_users
      vars:
        debug_mode: true
        debug_lang: "russian"
        users_to_add:
          - username: "admin"
            password: "AdminPass123"
            groups: ["wheel", "docker"]
            is_sudoers: true
            shell: "/bin/bash"
            uid: 1001
            create_home: true
          - username: "operator"
            password: "OpPass123"
            groups: ["operators"]
            is_sudoers: false
        security_groups:
          operators:
            members: ["operator"]
            commands:
              - "/bin/systemctl restart *"
              - "/bin/systemctl stop *"
            nopasswd: false
```

### Усиление безопасности

```yaml
- hosts: servers
  roles:
    - role: base.add_users
      vars:
        # Расширенные настройки безопасности
        add_users_validate_passwords: true
        add_users_min_password_length: 12
        password_max_age: 60
        password_warn_age: 7
        account_inactive_days: 15
        pam_deny_attempts: 3
        pam_unlock_time: 1800
        password_remember_count: 24
        
        # Безопасные права
        umask_system_users: '0027'
        home_dir_permissions: '0700'
        
        users_to_add:
          - username: "secure_user"
            password: "VerySecurePassword123!"
            is_sudoers: true
```

## Поток выполнения задач

### 1. Предварительные проверки
- Валидация версии Ansible (≥2.14)
- Проверка совместимости ОС
- Валидация версии Python (≥3.8)
- Сбор системной информации

### 2. Валидация входных данных
- Валидация обязательных параметров
- Валидация формата имен пользователей
- Валидация надежности паролей
- Проверка зарезервированных имен
- Обнаружение дубликатов имен пользователей

### 3. Управление группами
- Извлечение уникальных групп из конфигурации пользователей
- Создание необходимых групп
- Обработка ошибок создания групп с продолжением выполнения

### 4. Управление пользователями
- Создание новых пользователей с полной конфигурацией
- Обновление существующих пользователей
- Настройка членства в группах
- Настройка домашних директорий с правильными правами

### 5. Конфигурация sudo
- Создание гранулярных файлов sudoers
- Настройка групп безопасности
- Валидация конфигурации sudoers
- Очистка неиспользуемых файлов sudoers

### 6. Усиление безопасности
- Конфигурация PAM для политик паролей
- Настройка политик блокировки аккаунтов
- Конфигурация истории паролей
- Применение безопасных прав

## Обработка ошибок

### Graceful Degradation
- Продолжение выполнения при частичных сбоях
- Логирование подробной информации об ошибках
- Предоставление механизмов отката
- Поддержание стабильности системы

### Механизмы повторов
- Автоматические повторы для временных сбоев
- Настраиваемое количество повторов и задержки
- Экспоненциальная задержка для критических операций

### Поддержка отката
- Автоматическое создание резервных копий
- Восстановление конфигурации при сбоях
- Механизмы восстановления состояния

## Логирование

### Структурированное логирование
Все операции логируются в структурированном JSON формате:

```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "level": "INFO",
  "event_type": "USER_CREATION",
  "user": "ansible_user",
  "host": "target_host",
  "correlation_id": "1705312200",
  "message": "Пользователь создан успешно",
  "metadata": {
    "username": "john",
    "groups": ["docker", "wheel"],
    "sudo_privileges": true
  }
}
```

### Отладочный вывод
- Подробные сводки операций
- Поддержка двух языков (английский/русский)
- Маскирование паролей для безопасности
- Метрики производительности

## Соображения безопасности

### Безопасность паролей
- Пароли хешируются с использованием SHA-512
- Маскирование паролей в отладочном выводе
- Настраиваемые требования к надежности паролей
- Отслеживание истории паролей

### Права на файлы
- Безопасные права на домашние директории
- Правильные права на файлы sudoers
- Настраиваемые настройки umask
- Безопасность файлов резервных копий

### Контроль доступа
- Контроль доступа на основе ролей
- Гранулярные разрешения sudo
- Политики блокировки аккаунтов
- Ведение аудиторского следа

## Оптимизация производительности

### Оптимизация выполнения
- Параллельное выполнение задач где возможно
- Условное выполнение задач
- Эффективный сбор фактов
- Оптимизация ресурсов

### Мониторинг
- Отслеживание времени выполнения
- Мониторинг использования ресурсов
- Сбор метрик производительности
- Выявление узких мест

## Устранение неполадок

### Частые проблемы
1. **Отказ в доступе**: Убедитесь в наличии root привилегий
2. **Конфигурация PAM**: Проверьте установку пакетов
3. **Валидация sudoers**: Используйте `visudo -c` для валидации
4. **Создание пользователей**: Проверьте формат имени пользователя и доступность

### Режим отладки
```yaml
debug_mode: true
debug_lang: "russian"
debug_show_passwords: true  # ТОЛЬКО для тестирования!
```

### Анализ логов
- Проверьте структурированные логи для подробной информации
- Используйте корреляционные ID для отслеживания операций
- Мониторьте паттерны ошибок
- Валидируйте изменения конфигурации

## Лучшие практики

### Безопасность
- Используйте надежные пароли
- Включайте валидацию паролей
- Настройте соответствующие политики блокировки
- Регулярные аудиты безопасности

### Конфигурация
- Используйте Ansible Vault для чувствительных данных
- Реализуйте принципы минимальных привилегий
- Регулярное резервное копирование конфигураций
- Мониторинг использования sudo

### Обслуживание
- Регулярные обновления паролей
- Обзоры групп безопасности
- Аудит разрешений
- Анализ логов

## Поддержка

По вопросам и проблемам:
- **Автор**: Mad-Axell [mad.axell@gmail.com]
- **Лицензия**: MIT
- **Версия**: 1.0.0
- **Версия Ansible**: 2.14+
