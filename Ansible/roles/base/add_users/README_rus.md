# base/add_users - Полная русская документация

## Содержание

1. [Обзор](#обзор)
2. [Требования](#требования)
3. [Переменные роли](#переменные-роли)
4. [Зависимости](#зависимости)
5. [Примеры использования](#примеры-использования)
6. [Группы безопасности](#группы-безопасности)
7. [Функции безопасности](#функции-безопасности)
8. [Обработка ошибок](#обработка-ошибок)
9. [Производительность](#производительность)
10. [Устранение неполадок](#устранение-неполадок)
11. [Разработка](#разработка)

## Обзор

Роль `base/add_users` представляет собой комплексное решение для управления пользователями в Linux системах, предоставляющее корпоративные функции, включая создание пользователей, управление sudo привилегиями, усиление безопасности и кроссплатформенную поддержку.

### Ключевые возможности

- **Управление пользователями**: Создание, обновление и настройка учетных записей пользователей с полной кастомизацией
- **Конфигурация Sudo**: Гранулярные sudo привилегии с группами безопасности и ограничениями команд
- **Усиление безопасности**: Политики паролей, конфигурация PAM, блокировка аккаунтов и контроль доступа
- **Кроссплатформенность**: Поддержка Ubuntu, Debian, RHEL и openSUSE систем
- **Комплексная валидация**: Валидация входных данных, обработка ошибок и механизмы отката
- **Структурированное логирование**: Детальное логирование в формате JSON для интеграции с агрегаторами логов
- **Идемпотентные операции**: Безопасно выполнять многократно с консистентными результатами

### Поддерживаемые операционные системы

| Семейство ОС | Версии | Менеджер пакетов |
|--------------|--------|------------------|
| Ubuntu       | 20.04, 22.04, 24.04 | apt |
| Debian       | 11, 12 | apt |
| RHEL         | 8, 9 | yum/dnf |
| openSUSE     | 15 | zypper |

## Требования

### Требования Ansible

- **Версия Ansible**: 2.14 или выше
- **Версия Python**: 3.8 или выше
- **Коллекции**: Использует только модули `ansible.builtin`

### Системные требования

- **Дисковое пространство**: Минимум 1 ГБ свободного места
- **Память**: Минимум 512 МБ ОЗУ
- **Сеть**: Доступ в интернет для установки пакетов
- **Привилегии**: Требуется root или sudo доступ

### Необходимые пакеты

Роль автоматически устанавливает следующие пакеты:
- `sudo` - Для повышения привилегий
- `passwd` - Для управления паролями

## Переменные роли

### Обязательные переменные

#### `users_to_add`
**Тип**: `list`  
**Обязательная**: `true`  
**Описание**: Список пользователей для создания или обновления с их параметрами конфигурации

```yaml
users_to_add:
  - username: "john_doe"           # Строка. Имя пользователя (только строчные буквы, цифры, подчеркивания)
    password: "SecurePass123"      # Строка. Пароль открытым текстом (будет автоматически захеширован)
    groups: ["docker", "wheel"]    # Список. Системные группы пользователя (необязательно)
    security_groups: ["operators"] # Список. Группы безопасности для sudo привилегий (необязательно)
    is_sudoers: true               # Логическое значение. Предоставить sudo привилегии (необязательно, по умолчанию: false)
    shell: "/bin/bash"             # Строка. Оболочка пользователя (необязательно, по умолчанию: /bin/bash)
    uid: 1001                      # Целое число. ID пользователя (необязательно, назначается автоматически)
    gid: 1001                      # Целое число. ID основной группы (необязательно, назначается автоматически)
    create_home: true              # Логическое значение. Создать домашнюю директорию (необязательно, по умолчанию: true)
    home: "/home/john_doe"         # Строка. Пользовательский путь домашней директории (необязательно)
    authorized_keys: []            # Список. SSH публичные ключи (необязательно)
    password_max_age: 90           # Целое число. Максимальный возраст пароля в днях (необязательно, требует password_max_age_override: true)
```

### Необязательные переменные

#### Конфигурация отладки
```yaml
debug_mode: false                  # Логическое значение. Включить детальный вывод отладки
debug_show_passwords: false        # Логическое значение. Показывать пароли в отладочном выводе (НЕБЕЗОПАСНО)
```

#### Настройки создания пользователей
```yaml
add_users_create_home: true        # Логическое значение. Настройка по умолчанию для создания домашней директории
add_users_home_prefix: "/home"     # Строка. Префикс пути для домашних директорий пользователей
add_users_default_shell: "/bin/bash" # Строка. Оболочка по умолчанию для пользователей
```

#### Валидация паролей
```yaml
add_users_validate_passwords: true # Логическое значение. Включить проверку надежности паролей
add_users_min_password_length: 8   # Целое число. Требуемая минимальная длина пароля
```

#### Конфигурация отката
```yaml
enable_rollback: true              # Логическое значение. Включить автоматический откат при ошибке
backup_config: true                # Логическое значение. Создавать резервную копию перед изменениями
```

#### Настройки производительности
```yaml
retries: 3                         # Целое число. Количество повторов для неудачных задач
retry_delay: 5                     # Целое число. Задержка между повторами в секундах
```

#### Политики безопасности
```yaml
password_max_age: 90               # Целое число. Максимальный возраст пароля в днях
password_warn_age: 14              # Целое число. Предупреждение о смене пароля за N дней
password_max_age_override: false   # Логическое значение. Разрешить индивидуальный password_max_age для каждого пользователя
account_inactive_days: 30          # Целое число. Дней до блокировки аккаунта после истечения пароля
pam_deny_attempts: 3               # Целое число. Неудачных попыток входа до блокировки
pam_unlock_time: 900               # Целое число. Время разблокировки аккаунта в секундах (15 минут)
password_remember_count: 12        # Целое число. Количество старых паролей для запоминания
password_history_file: /etc/security/opasswd # Строка. Путь к файлу истории паролей
umask_system_users: '0027'         # Строка. Umask для системных пользователей
home_dir_permissions: '0750'       # Строка. Права на домашние директории
```

#### Конфигурация групп безопасности
```yaml
security_groups:                   # Словарь. Группы безопасности с членами и разрешенными командами
  admins:                          # Полный административный доступ
    members: []                    # Список. Имена пользователей-администраторов
    commands:                      # Список. Разрешенные команды (пусто = ALL)
      - ALL
    nopasswd: true                 # Логическое значение. Разрешить NOPASSWD для этих команд
    
  operators:                       # Ограниченный операционный доступ
    members: []                    # Список. Имена пользователей-операторов
    commands:                      # Список. Разрешенные команды
      - /bin/systemctl restart *
      - /bin/systemctl stop *
      - /bin/systemctl start *
      - /bin/systemctl status *
      - /bin/journalctl *
      - /usr/bin/docker *
      - /usr/local/bin/docker-compose *
    nopasswd: false                # Логическое значение. Требовать пароль для этих команд
    
  auditors:                        # Доступ только на чтение для аудита
    members: []                    # Список. Имена пользователей-аудиторов
    commands:                      # Список. Разрешенные команды
      - /bin/cat /var/log/*
      - /bin/tail /var/log/*
      - /bin/grep * /var/log/*
      - /bin/journalctl *
      - /bin/systemctl status *
      - /usr/bin/find /var/log/*
    nopasswd: true                 # Логическое значение. Разрешить NOPASSWD для команд только на чтение
```

## Зависимости

Эта роль не имеет зависимостей от других ролей или коллекций. Использует только модули `ansible.builtin`.

## Примеры использования

### Базовое создание пользователей

```yaml
- hosts: all
  roles:
    - role: base/add_users
      vars:
        users_to_add:
          - username: "john_doe"
            password: "SecurePass123"
            groups: ["sudo", "docker"]        # Системные группы Linux
            security_groups: ["operators"]     # Группы безопасности для sudo
            is_sudoers: true
```

### Расширенная конфигурация пользователей

```yaml
- hosts: all
  roles:
    - role: base/add_users
      vars:
        debug_mode: true
        users_to_add:
          - username: "admin"
            password: "VerySecurePassword123!"
            groups: ["sudo", "docker", "wheel"]
            security_groups: ["admins"]
            is_sudoers: true
            shell: "/bin/bash"
            uid: 1001
            create_home: true
            home: "/home/admin"
            authorized_keys:
              - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC..."
            password_max_age: 60
            
          - username: "operator"
            password: "OperatorPass456!"
            groups: ["docker"]
            security_groups: ["operators"]
            is_sudoers: true
            shell: "/bin/zsh"
            
          - username: "auditor"
            password: "AuditorPass789!"
            groups: ["audit"]
            security_groups: ["auditors"]
            is_sudoers: true
            shell: "/bin/bash"
```

### Конфигурация групп безопасности (новый подход)

```yaml
- hosts: all
  roles:
    - role: base/add_users
      vars:
        security_groups:
          admins:
            members: []  # Заполняется автоматически из users_to_add
            commands: ["ALL"]
            nopasswd: true
            
          operators:
            members: []  # Заполняется автоматически из users_to_add
            commands:
              - "/bin/systemctl restart *"
              - "/bin/systemctl stop *"
              - "/usr/bin/docker *"
            nopasswd: false
            
          auditors:
            members: []  # Заполняется автоматически из users_to_add
            commands:
              - "/bin/cat /var/log/*"
              - "/bin/journalctl *"
            nopasswd: true
            
        users_to_add:
          - username: "admin"
            password: "AdminPass123!"
            groups: ["sudo", "wheel"]
            security_groups: ["admins"]
            is_sudoers: true
            
          - username: "operator1"
            password: "OperatorPass123!"
            groups: ["docker"]
            security_groups: ["operators"]
            is_sudoers: true
            
          - username: "auditor1"
            password: "AuditorPass123!"
            groups: ["audit"]
            security_groups: ["auditors"]
            is_sudoers: true
```

### Конфигурация групп безопасности (legacy подход)

```yaml
- hosts: all
  roles:
    - role: base/add_users
      vars:
        security_groups:
          admins:
            members: ["admin", "root_admin"]  # Явное указание пользователей
            commands: ["ALL"]
            nopasswd: true
            
          operators:
            members: ["operator1", "operator2"]
            commands:
              - "/bin/systemctl restart *"
              - "/bin/systemctl stop *"
              - "/usr/bin/docker *"
            nopasswd: false
            
        users_to_add:
          - username: "admin"
            password: "AdminPass123!"
            is_sudoers: true
            
          - username: "operator1"
            password: "OperatorPass123!"
            is_sudoers: true
```

### Продакшн конфигурация с усилением безопасности

```yaml
- hosts: production_servers
  roles:
    - role: base/add_users
      vars:
        # Усиление безопасности
        add_users_validate_passwords: true
        add_users_min_password_length: 12
        password_max_age: 60
        password_warn_age: 7
        account_inactive_days: 14
        pam_deny_attempts: 3
        pam_unlock_time: 1800  # 30 минут
        
        # Откат и резервное копирование
        enable_rollback: true
        backup_config: true
        
        # Логирование
        log_file: "/var/log/ansible-user-management.log"
        
        # Пользователи
        users_to_add:
          - username: "sysadmin"
            password: "{{ vault_sysadmin_password }}"
            is_sudoers: true
            groups: ["sudo", "docker", "wheel"]
            shell: "/bin/bash"
            password_max_age: 30
            
          - username: "developer"
            password: "{{ vault_developer_password }}"
            is_sudoers: true
            groups: ["docker", "developers"]
            shell: "/bin/zsh"
```

## Группы безопасности

Группы безопасности предоставляют способ назначения гранулярных sudo привилегий пользователям на основе их роли в организации.

### Различие между `groups` и `security_groups`

- **`groups`** - системные группы Linux (docker, wheel, sudo, etc.), которые определяют членство пользователя в системных группах
- **`security_groups`** - логические группы для настройки sudo привилегий, определяющие какие команды может выполнять пользователь

### Новый подход (рекомендуемый)

```yaml
users_to_add:
  - username: "operator1"
    groups: ["docker", "wheel"]        # Системные группы Linux
    security_groups: ["operators"]     # Группы безопасности для sudo
    is_sudoers: true
```

### Legacy подход (поддерживается)

```yaml
security_groups:
  operators:
    members: ["operator1"]             # Явное указание пользователей
    commands: ["/bin/systemctl restart *"]
```

## Миграция с Legacy подхода

### Пошаговое руководство по миграции

1. **Определите текущие группы безопасности** в вашей конфигурации
2. **Добавьте поле `security_groups`** в каждый пользователь в `users_to_add`
3. **Очистите поле `members`** в `security_groups` (оставьте пустым)
4. **Протестируйте конфигурацию** в тестовой среде

### Пример миграции

**До (Legacy подход):**
```yaml
security_groups:
  operators:
    members: ["operator1", "operator2"]
    commands: ["/bin/systemctl restart *"]
    nopasswd: false

users_to_add:
  - username: "operator1"
    password: "Pass123!"
    is_sudoers: true
  - username: "operator2"
    password: "Pass456!"
    is_sudoers: true
```

**После (Новый подход):**
```yaml
security_groups:
  operators:
    members: []  # Очищено - заполняется автоматически
    commands: ["/bin/systemctl restart *"]
    nopasswd: false

users_to_add:
  - username: "operator1"
    password: "Pass123!"
    groups: ["docker"]              # Добавлены системные группы
    security_groups: ["operators"]  # Добавлены группы безопасности
    is_sudoers: true
  - username: "operator2"
    password: "Pass456!"
    groups: ["wheel"]
    security_groups: ["operators"]
    is_sudoers: true
```

### Преимущества нового подхода

- **Централизованная конфигурация**: Все настройки пользователя в одном месте
- **Лучшая читаемость**: Легче понять, какие права у пользователя
- **Автоматическое управление**: Не нужно дублировать имена пользователей
- **Гибкость**: Один пользователь может быть в нескольких группах безопасности

### Предустановленные группы

#### `admins`
- **Назначение**: Полный административный доступ
- **Команды**: `ALL` (без ограничений)
- **NOPASSWD**: `true` (пароль не требуется)
- **Применение**: Системные администраторы, доступ уровня root

#### `operators`
- **Назначение**: Ограниченный операционный доступ
- **Команды**: 
  - `/bin/systemctl restart *`
  - `/bin/systemctl stop *`
  - `/bin/systemctl start *`
  - `/bin/systemctl status *`
  - `/bin/journalctl *`
  - `/usr/bin/docker *`
  - `/usr/local/bin/docker-compose *`
- **NOPASSWD**: `false` (пароль требуется)
- **Применение**: Операционная команда, управление сервисами

#### `auditors`
- **Назначение**: Доступ только на чтение для аудита
- **Команды**:
  - `/bin/cat /var/log/*`
  - `/bin/tail /var/log/*`
  - `/bin/grep * /var/log/*`
  - `/bin/journalctl *`
  - `/bin/systemctl status *`
  - `/usr/bin/find /var/log/*`
- **NOPASSWD**: `true` (пароль не требуется для чтения)
- **Применение**: Аудиторы безопасности, мониторинг соответствия

### Пользовательские группы безопасности

Вы можете определить пользовательские группы безопасности, добавив их в словарь `security_groups`:

```yaml
security_groups:
  developers:
    members: ["dev1", "dev2"]
    commands:
      - "/usr/bin/git *"
      - "/usr/bin/docker *"
      - "/usr/local/bin/kubectl *"
    nopasswd: false
    
  database_admins:
    members: ["dbadmin1"]
    commands:
      - "/usr/bin/mysql *"
      - "/usr/bin/psql *"
      - "/usr/bin/mongodump *"
    nopasswd: false
```

## Функции безопасности

### Политики паролей

Роль реализует комплексные политики паролей:

- **Минимальная длина**: Настраиваемая минимальная длина пароля (по умолчанию: 8 символов)
- **История паролей**: Предотвращает повторное использование недавних паролей (по умолчанию: 12 паролей)
- **Устаревание паролей**: Настраиваемое истечение паролей (по умолчанию: 90 дней)
- **Сложность паролей**: Интеграция PAM для требований качества паролей

### Конфигурация PAM

Для систем Debian/Ubuntu роль настраивает модули PAM:

- **pam_pwquality**: Принуждение качества паролей
- **pam_faillock**: Блокировка аккаунта после неудачных попыток
- **pam_unix**: История и устаревание паролей

### Безопасность аккаунтов

- **Блокировка аккаунтов**: Автоматическая блокировка после неудачных попыток входа
- **Блокировка неактивности**: Блокировка аккаунта после истечения пароля для не-sudo пользователей
- **Права домашних директорий**: Безопасные права на домашние директории пользователей
- **Защита зарезервированных имен**: Предотвращает создание зарезервированных системных имен пользователей

### Безопасность Sudo

- **Гранулярные привилегии**: Правила sudo для конкретных команд
- **Группы безопасности**: Контроль доступа на основе ролей
- **Валидация**: Автоматическая валидация файлов sudoers
- **Резервное копирование**: Автоматическое резервное копирование конфигурации sudoers

## Обработка ошибок

### Механизм отката

Роль реализует автоматический откат при ошибках:

```yaml
enable_rollback: true    # Включить автоматический откат
backup_config: true      # Создавать резервные копии перед изменениями
```

### Восстановление после ошибок

- **Паттерн Block-Rescue**: Структурированная обработка ошибок с восстановлением
- **Обработка частичных сбоев**: Продолжение выполнения когда возможно
- **Детальное логирование ошибок**: Комплексный контекст ошибок и трассировка стека
- **Сбои валидации**: Четкие сообщения об ошибках для проблем конфигурации

### Стратегия резервного копирования

- **Резервные копии конфигурации**: Автоматическое резервное копирование измененных файлов
- **Резервные копии с временными метками**: Уникальные имена резервных копий с временными метками
- **Возможность отката**: Автоматическое восстановление при сбоях

## Производительность

### Функции оптимизации

- **Идемпотентные операции**: Безопасно выполнять многократно
- **Условное выполнение**: Пропуск ненужных операций
- **Параллельная обработка**: Эффективное создание групп и пользователей
- **Минимальный сбор фактов**: Сбор только необходимой системной информации

### Использование ресурсов

- **Память**: Минимальный объем памяти
- **Диск**: Небольшие временные файлы, очищаемые после выполнения
- **Сеть**: Только для установки пакетов
- **CPU**: Эффективная обработка с минимальной нагрузкой

## Устранение неполадок

### Распространенные проблемы

#### 1. Сбои валидации паролей

**Проблема**: Пароль не соответствует требованиям сложности

**Решение**: 
```yaml
# Отключить валидацию паролей (не рекомендуется для продакшна)
add_users_validate_passwords: false

# Или увеличить минимальную длину
add_users_min_password_length: 6
```

#### 2. Ошибки валидации Sudoers

**Проблема**: Валидация `visudo` не проходит

**Решение**:
```bash
# Проверить синтаксис sudoers вручную
sudo visudo -c

# Проверить конкретный файл пользователя
sudo visudo -c /etc/sudoers.d/username
```

#### 3. Сбои создания пользователей

**Проблема**: Создание пользователя не удается с ошибками прав доступа

**Решение**:
- Убедитесь, что playbook выполняется с соответствующими привилегиями
- Проверьте, не конфликтует ли имя пользователя с существующими пользователями
- Убедитесь, что диапазоны UID/GID доступны

#### 4. Проблемы конфигурации PAM

**Проблема**: Модули PAM работают некорректно

**Решение**:
```bash
# Проверить конфигурацию PAM
sudo pam-auth-update

# Тестировать качество паролей
echo "password" | sudo pam_test_password
```

### Режим отладки

Включить режим отладки для детального вывода:

```yaml
debug_mode: true
debug_show_passwords: true  # ВНИМАНИЕ: Показывает пароли в логах
```

### Логирование

Проверить структурированный файл лога для детальной информации об операциях:

```bash
tail -f /var/log/ansible-changes.log
```

## Разработка

### Тестирование

Роль включает комплексные возможности тестирования:

```bash
# Запустить тесты роли
ansible-playbook -i inventory test-playbook.yml --check

# Тестировать с режимом отладки
ansible-playbook -i inventory test-playbook.yml -e debug_mode=true
```

### Вклад в разработку

При вкладе в эту роль:

1. Следуйте стандартам кодирования в `ansible-expert-cursor-rules.md`
2. Добавляйте комплексные тесты для новых функций
3. Обновляйте документацию для любых изменений
4. Обеспечивайте кроссплатформенную совместимость
5. Поддерживайте идемпотентность

### Структура кода

```
roles/base/add_users/
├── defaults/main.yml          # Переменные по умолчанию
├── handlers/main.yml          # Обработчики событий
├── meta/
│   ├── main.yml              # Метаданные роли
│   └── argument_specs.yml    # Валидация входных данных
├── tasks/
│   ├── main.yml              # Основной поток задач
│   ├── validate.yml          # Валидация входных данных
│   ├── security.yml          # Усиление безопасности
│   ├── sudoers_granular.yml  # Конфигурация sudo
│   ├── preflight.yml         # Предварительные проверки
│   └── install_packages.yml  # Установка пакетов
├── templates/sudoers.d/user.j2 # Шаблон sudoers
├── vars/main.yml             # Внутренние переменные
├── README.md                 # Краткий справочник
├── README_eng.md            # Полная английская документация
└── README_rus.md            # Полная русская документация
```

### История версий

- **v1.0.0**: Первый релиз с базовым управлением пользователями
- **v1.1.0**: Добавлены группы безопасности и гранулярный sudo
- **v1.2.0**: Улучшено усиление безопасности и интеграция PAM
- **v1.3.0**: Добавлено структурированное логирование и обработка ошибок
- **v1.4.0**: Кроссплатформенная поддержка и оптимизация производительности

---

**Лицензия**: MIT  
**Автор**: Mad-Axell [mad.axell@gmail.com]  
**Сопровождающий**: Ansible Admin [admin@example.com]
