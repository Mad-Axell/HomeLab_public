# add_users - Роль управления пользователями

**Роль:** `base.add_users`  
**Описание:** Комплексная роль управления пользователями с sudo привилегиями и конфигурацией групп  
**Автор:** Mad-Axell [mad.axell@gmail.com]  
**Лицензия:** MIT  
**Минимальная версия Ansible:** 2.14  
**Поддерживаемые платформы:** Ubuntu 20.04+, Debian 11+

## Обзор

Роль `add_users` предоставляет комплексные возможности управления учетными записями пользователей в Linux системах, включая создание пользователей, настройку sudo привилегий, управление группами безопасности и усиление безопасности. Поддерживает гранулярные sudo разрешения через группы безопасности и включает обширные функции валидации и логирования.

## Возможности

### Основная функциональность
- **Управление учетными записями**: Создание и обновление учетных записей пользователей с полными опциями конфигурации
- **Sudo привилегии**: Настройка sudo доступа с гранулярными разрешениями через группы безопасности
- **Управление группами**: Автоматическое создание и управление пользовательскими группами
- **Управление паролями**: Безопасная обработка паролей с автоматическим хешированием

### Функции безопасности
- **Политики паролей**: Настраиваемое устаревание паролей, требования сложности и история
- **Конфигурация PAM**: Автоматическая настройка PAM модулей для качества паролей и блокировки аккаунтов
- **Безопасность аккаунтов**: Блокировка неактивных аккаунтов и безопасные права на домашние директории
- **Валидация входных данных**: Комплексная валидация имен пользователей, паролей и конфигурации

### Расширенные возможности
- **Структурированное логирование**: JSON-форматированное логирование всех операций и изменений
- **Обработка ошибок**: Паттерны block-rescue с автоматическим откатом при сбоях
- **Группы безопасности**: Гранулярные sudo разрешения с ограничениями команд
- **Валидация**: Предварительные проверки и комплексная валидация входных данных

## Требования

### Системные требования
- **Операционная система**: Дистрибутивы семейства Debian (Ubuntu 20.04+, Debian 11+)
- **Версия Ansible**: 2.14 или выше
- **Версия Python**: 3.8 или выше
- **Привилегии**: Требуется root доступ для операций управления пользователями

### Необходимые пакеты
Роль автоматически устанавливает следующие пакеты:
- `sudo` - Управление sudo привилегиями
- `passwd` - Утилиты управления паролями

## Переменные роли

### Обязательные переменные

#### `users_to_add`
**Тип:** `list`  
**Обязательная:** `true`  
**Описание:** Список пользователей для создания или обновления с их параметрами конфигурации

**Структура объекта пользователя:**
```yaml
users_to_add:
  - username: "user1"                    # Обязательно: Имя пользователя (строчные, буквенно-цифровые, подчеркивания)
    password: "SecurePass123"            # Обязательно: Пароль открытым текстом (будет захеширован)
    groups: ["docker", "wheel"]          # Опционально: Список групп
    is_sudoers: true                     # Опционально: Предоставить sudo привилегии (по умолчанию: false)
    shell: "/bin/bash"                   # Опционально: Оболочка пользователя (по умолчанию: /bin/bash)
    uid: 1001                            # Опционально: ID пользователя (автоназначение если не указано)
    gid: 1001                            # Опционально: ID основной группы
    create_home: true                    # Опционально: Создать домашнюю директорию (по умолчанию: true)
    home: "/home/user1"                  # Опционально: Пользовательский путь домашней директории
    security_groups: ["admins"]          # Опционально: Группы безопасности для гранулярного sudo
    password_max_age: 90                 # Опционально: Индивидуальный максимальный возраст пароля (требует override)
```

### Опциональные переменные

#### Конфигурация отладки
```yaml
debug_mode: false                        # Логическое значение: Включить детальный вывод отладки
debug_show_passwords: false              # Логическое значение: Показывать пароли в отладке (НЕБЕЗОПАСНО)
```

#### Настройки создания пользователей по умолчанию
```yaml
add_users_create_home: true              # Логическое значение: Создавать домашнюю директорию по умолчанию
add_users_home_prefix: "/home"           # Строка: Префикс домашней директории
add_users_default_shell: "/bin/bash"     # Строка: Оболочка по умолчанию для пользователей
```

#### Валидация паролей
```yaml
add_users_validate_passwords: true       # Логическое значение: Включить валидацию паролей
add_users_min_password_length: 8         # Целое число: Минимальная длина пароля
```

#### Конфигурация безопасности
```yaml
password_max_age: 90                     # Целое число: Максимальный возраст пароля в днях
password_warn_age: 14                    # Целое число: Предупреждение о смене пароля за N дней
account_inactive_days: 30                # Целое число: Дней до блокировки аккаунта после истечения пароля
password_max_age_override: false         # Логическое значение: Разрешить индивидуальный password_max_age для каждого пользователя
pam_deny_attempts: 3                     # Целое число: Неудачных попыток входа до блокировки
pam_unlock_time: 900                     # Целое число: Время разблокировки аккаунта в секундах (15 мин)
password_remember_count: 12              # Целое число: Количество старых паролей для запоминания
password_history_file: /etc/security/opasswd  # Строка: Файл истории паролей
umask_system_users: '0027'               # Строка: Umask для системных пользователей
home_dir_permissions: '0750'             # Строка: Права на домашние директории
min_uid: 1000                            # Целое число: Минимальный UID для обычных пользователей
max_uid: 60000                           # Целое число: Максимальный UID для обычных пользователей
enable_pam_configuration: true          # Логическое значение: Включить конфигурацию PAM модулей
enable_pam_validation: true             # Логическое значение: Включить валидацию учетных данных перед настройкой PAM
enable_faillock_in_containers: false    # Логическое значение: Принудительно включить faillock в контейнерах (НЕ РЕКОМЕНДУЕТСЯ)
```

#### Конфигурация групп безопасности
```yaml
security_groups:                         # Словарь: Группы безопасности с членами и командами
  admins:                                # Полный административный доступ
    members: []                          # Список: Имена пользователей-администраторов
    commands:                            # Список: Разрешенные команды (пусто = ALL)
      - ALL
    nopasswd: false                      # Логическое значение: Разрешить NOPASSWD для этих команд
  
  operators:                             # Ограниченный операционный доступ
    members: []                          # Список: Имена пользователей-операторов
    commands:                            # Список: Разрешенные команды
      - /bin/systemctl restart *
      - /bin/systemctl stop *
      - /bin/systemctl start *
      - /bin/systemctl status *
      - /bin/journalctl *
      - /usr/bin/docker *
      - /usr/local/bin/docker-compose *
    nopasswd: false                      # Логическое значение: Требовать пароль для этих команд
  
  auditors:                              # Доступ только на чтение для аудита
    members: []                          # Список: Имена пользователей-аудиторов
    commands:                            # Список: Разрешенные команды
      - /bin/cat /var/log/*
      - /bin/tail /var/log/*
      - /bin/grep * /var/log/*
      - /bin/journalctl *
      - /bin/systemctl status *
      - /usr/bin/find /var/log/*
    nopasswd: false                      # Логическое значение: Разрешить NOPASSWD для команд только на чтение
```

#### Откат и производительность
```yaml
enable_rollback: true                    # Логическое значение: Включить автоматический откат при ошибке
backup_config: true                      # Логическое значение: Создавать резервную копию перед изменениями
async_timeout: 300                       # Целое число: Таймаут для асинхронных операций (секунды)
retries: 3                               # Целое число: Количество попыток повтора для неудачных задач
retry_delay: 5                           # Целое число: Задержка между повторами (секунды)
```

#### Логирование
```yaml
log_file: "/var/log/ansible-changes.log"  # Строка: Путь к файлу структурированного лога
```

## Зависимости

Отсутствуют. Роль самодостаточна и не зависит от других ролей.

## Пример Playbook

### Базовое создание пользователей
```yaml
---
- hosts: all
  become: true
  vars:
    users_to_add:
      - username: admin_user
        password: "SecurePass123"
        is_sudoers: true
        groups: ["docker", "wheel"]
      - username: developer
        password: "DevPass456"
        groups: ["docker"]
        shell: "/bin/zsh"
  roles:
    - base.add_users
```

### Расширенная конфигурация с группами безопасности
```yaml
---
- hosts: all
  become: true
  vars:
    users_to_add:
      - username: sysadmin
        password: "AdminPass789"
        is_sudoers: true
        security_groups: ["admins"]
        groups: ["docker", "wheel"]
      - username: operator
        password: "OpPass123"
        is_sudoers: true
        security_groups: ["operators"]
        groups: ["docker"]
      - username: auditor
        password: "AuditPass456"
        is_sudoers: true
        security_groups: ["auditors"]
    
    security_groups:
      admins:
        members: ["sysadmin"]
        commands: ["ALL"]
        nopasswd: false
      operators:
        members: ["operator"]
        commands:
          - /bin/systemctl restart *
          - /bin/systemctl stop *
          - /bin/systemctl start *
          - /usr/bin/docker *
        nopasswd: false
      auditors:
        members: ["auditor"]
        commands:
          - /bin/cat /var/log/*
          - /bin/journalctl *
        nopasswd: true
    
    debug_mode: true
    add_users_validate_passwords: true
    password_max_age: 60
    enable_rollback: true
    
  roles:
    - base.add_users
```

### Индивидуальные политики паролей
```yaml
---
- hosts: all
  become: true
  vars:
    users_to_add:
      - username: admin
        password: "AdminPass123"
        is_sudoers: true
        password_max_age: 30  # 30 дней для админа
      - username: user
        password: "UserPass456"
        password_max_age: 90  # 90 дней для обычного пользователя
    
    password_max_age_override: true  # Включить индивидуальные политики паролей
    
  roles:
    - base.add_users
```

### Использование в контейнерах
```yaml
---
- hosts: containers
  become: true
  vars:
    users_to_add:
      - username: app_user
        password: "SecurePass123!"
        groups: ["docker"]
        shell: "/bin/bash"
    
    # PAM конфигурация автоматически адаптируется для контейнеров
    # faillock будет отключен автоматически
    enable_pam_configuration: true
    enable_pam_validation: true
    
    # Для принудительного включения faillock (не рекомендуется):
    # enable_faillock_in_containers: true
    
    debug_mode: true  # Включить проверку логина пользователей
    
  roles:
    - base.add_users
```

### Использование с Proxmox
```yaml
---
- hosts: proxmox_hosts
  become: true
  vars:
    users_to_add:
      - username: proxmox_admin
        password: "ProxmoxPass123!"
        is_sudoers: true
        groups: []
        shell: "/bin/bash"
      - username: proxmox_user
        password: "UserPass456!"
        shell: "/bin/bash"
    
    # Роль автоматически проверит совместимость с Proxmox
    enable_pam_configuration: true
    debug_mode: true
    
  roles:
    - base.add_users
```

## Функции безопасности

### Политики паролей
- **Устаревание паролей**: Настраиваемый максимальный возраст пароля с индивидуальными переопределениями
- **Сложность паролей**: Требования минимальной длины и валидация сложности
- **История паролей**: Предотвращение повторного использования недавних паролей
- **Блокировка аккаунтов**: Автоматическая блокировка аккаунтов после неудачных попыток входа

### Конфигурация PAM
Роль автоматически настраивает PAM модули для:
- **Качество паролей**: `pam_pwquality` для сложности паролей
- **Блокировка аккаунтов**: `pam_faillock` для защиты от неудачных попыток входа
- **История паролей**: `pam_unix` с отслеживанием истории паролей

#### ⚠️ Важно: PAM в контейнерах

**Автоматическое определение контейнеров:**
Роль автоматически определяет контейнерную среду (Docker, LXC, Kubernetes) и **отключает faillock** в контейнерах по следующим причинам:

1. **Эфемерное хранилище**: `/var/run/faillock` обычно находится в tmpfs и очищается при перезапуске контейнера
2. **Потеря состояния**: Счетчики неудачных попыток сбрасываются при перезапуске, делая отслеживание неэффективным
3. **Проблемы с блокировками**: Состояние блокировки может некорректно сохраняться после перезапуска контейнера
4. **Альтернативная безопасность**: Контейнеры используют сетевую изоляцию и ограничения ресурсов для безопасности

**Принудительное включение faillock в контейнерах:**
Если вам необходимо включить faillock в контейнерах (не рекомендуется), установите:
```yaml
enable_faillock_in_containers: true  # НЕ РЕКОМЕНДУЕТСЯ
```

**Проверка логина пользователей:**
После применения роли выполняется автоматическая проверка возможности логина пользователей:
- Проверка блокировки через faillock
- Проверка системной блокировки аккаунтов
- Тест доступа через sudo
- Проверка совместимости с SSH и Proxmox
- Валидация PAM конфигурации

**Совместимость с Proxmox:**
Роль проверяет совместимость пользователей с Proxmox веб-интерфейсом:
- Пользователи аутентифицируются через PAM (уже настроено)
- Проверяется валидность shell для Proxmox
- Рекомендации по настройке прав в веб-интерфейсе Proxmox

### Права доступа к файлам
- **Домашние директории**: Безопасные права (0750) для домашних директорий пользователей
- **Файлы sudoers**: Правильные права (0440) для файлов конфигурации sudo
- **История паролей**: Безопасные права (0600) для файла истории паролей

## Структурированное логирование

Роль реализует комплексное структурированное логирование в JSON формате. Все операции логируются в `/var/log/ansible-changes.log` (настраивается) со следующей информацией:

- **Временная метка**: Формат ISO 8601
- **Тип события**: Тип операции (USER_CREATE, PACKAGE_INSTALL, и т.д.)
- **Пользователь**: Пользователь Ansible, выполняющий операцию
- **Хост**: Имя целевого хоста
- **ID корреляции**: Уникальный идентификатор для отслеживания связанных операций
- **Метаданные**: Контекстная информация, специфичная для каждой операции

### Типы событий лога
- `USER_CREATE`: Создание учетной записи пользователя
- `PACKAGE_INSTALL`: Установка пакетов
- `CONFIG_CHANGE`: Изменения файлов конфигурации
- `SERVICE_CHANGE`: Изменения состояния служб
- `PERMISSION_CHANGE`: Изменения прав доступа к файлам
- `TASK_FAILURE`: Сбои выполнения задач

## Обработка ошибок

Роль реализует комплексную обработку ошибок с:

### Паттерны Block-Rescue
- **Создание пользователей**: Автоматический откат при сбоях создания пользователей
- **Изменения конфигурации**: Резервное копирование и восстановление при сбоях конфигурации
- **Установка пакетов**: Корректная обработка сбоев установки пакетов

### Механизмы отката
- **Резервное копирование конфигурации**: Автоматическое резервное копирование измененных файлов конфигурации
- **Восстановление учетных записей**: Откат изменений учетных записей пользователей при сбоях
- **Валидация sudoers**: Автоматическая валидация и откат недопустимых конфигураций sudoers

## Валидация

### Предварительные проверки
- **Версия Ansible**: Обеспечивает минимальную версию Ansible (2.14+)
- **Совместимость ОС**: Валидирует дистрибутив семейства Debian
- **Версия Python**: Обеспечивает минимальную версию Python (3.8+)

### Валидация входных данных
- **Формат имени пользователя**: Валидирует соответствие имени пользователя системным соглашениям
- **Надежность пароля**: Валидирует соответствие пароля минимальным требованиям
- **Валидация оболочки**: Обеспечивает нахождение оболочки в списке разрешенных
- **Диапазон UID**: Валидирует нахождение UID в допустимом диапазоне
- **Обнаружение дубликатов**: Предотвращает дублирующиеся имена пользователей в конфигурации

## Теги

Роль поддерживает следующие теги для выборочного выполнения:

- `always`: Всегда выполняемые задачи
- `debug`: Задачи вывода отладки
- `facts`: Задачи сбора фактов
- `groups`: Задачи управления группами
- `install`: Задачи установки пакетов
- `packages`: Задачи, связанные с пакетами
- `preflight`: Задачи предварительных проверок
- `security`: Задачи конфигурации безопасности
- `sudo`: Задачи конфигурации sudo
- `users`: Задачи управления пользователями
- `validation`: Задачи валидации входных данных

## Возвращаемые значения

Роль устанавливает следующие факты:

- `existing_usernames`: Список существующих системных имен пользователей
- `unique_groups`: Список уникальных групп для создания
- `user_security_groups_map`: Сопоставление пользователей с группами безопасности
- `validation_stats`: Статистика валидации

## Устранение неполадок

### Частые проблемы

1. **Отказ в доступе**: Убедитесь, что playbook запускается с `become: true`
2. **Недопустимое имя пользователя**: Проверьте соответствие имени пользователя системным соглашениям (строчные, буквенно-цифровые, подчеркивания)
3. **Пароль слишком короткий**: Убедитесь, что пароль соответствует требованиям минимальной длины
4. **Сбой валидации sudoers**: Проверьте конфигурацию групп безопасности и синтаксис команд

### Режим отладки

Включите режим отладки для детального вывода:
```yaml
vars:
  debug_mode: true
  debug_show_passwords: true  # ВНИМАНИЕ: Показывает пароли в выводе
```

### Анализ логов

Проверьте файл структурированного лога для детальной информации об операциях:
```bash
tail -f /var/log/ansible-changes.log | jq .
```

## Лицензия

MIT

## Информация об авторе

**Автор:** Mad-Axell  
**Email:** mad.axell@gmail.com  
**Версия роли:** 1.0.0  
**Последнее обновление:** 2024
