# Proxmox Import Config Role - Русская документация

## Обзор

Роль `proxmox_import_config` предназначена для импорта и валидации конфигурационных переменных для развертывания LXC контейнеров Proxmox из централизованного хранилища секретов и файлов переменных хостов. Роль обеспечивает комплексную валидацию, структурированное логирование и автоматический откат при ошибках.

## Возможности

- **Централизованное управление секретами**: Импорт секретов из централизованного YAML файла
- **Импорт переменных хоста**: Загрузка конфигурационных переменных хоста
- **Валидация синтаксиса YAML**: Проверка синтаксиса YAML всех конфигурационных файлов
- **Структурированное JSON логирование**: Логирование всех операций в структурированном JSON формате
- **Комплексная валидация**: Проверка существования файлов, синтаксиса и структуры

## Требования

### Системные требования
- Ansible 2.14 или выше
- Python 3.8 или выше
- Доступ к файлам секретов и host_vars

### Требования к структуре файлов
```
/etc/ansible/
├── VARS/
│   └── secrets.yaml          # Централизованный файл секретов
├── host_vars/
│   └── {host_name}.yml       # Переменные хоста
└── hosts.yml                 # Файл инвентори
```

## Переменные роли

### Обязательные переменные

| Переменная | Тип | Описание |
|------------|-----|----------|
| `host_name` | string | Имя хоста для загрузки host_vars (должно совпадать с именем файла host_vars без расширения .yml) |
| `host_vars` | string | Префикс для переменных в secrets.yaml (используется для построения имен переменных) |

### Опциональные переменные

#### Настройки отладки и валидации

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `debug_mode` | boolean | `false` | Включить детальный отладочный вывод |
| `debug_sensitive` | boolean | `false` | Показывать пароли в отладке (НЕБЕЗОПАСНО) |
| `validate_parameters` | boolean | `true` | Включить валидацию параметров |
| `strict_validation` | boolean | `true` | Включить режим строгой валидации |

#### Конфигурация путей

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `ansible_base_dir` | string | `"/etc/ansible"` | Базовая директория для конфигурации Ansible |
| `ansible_host_vars_dir` | string | `"{{ ansible_base_dir }}/host_vars"` | Директория для переменных хоста |
| `ansible_vars_dir` | string | `"{{ ansible_base_dir }}/VARS"` | Директория для секретов и vault-файлов |
| `secrets_file_path` | string | `"{{ ansible_vars_dir }}/secrets.yaml"` | Путь к файлу секретов |
| `ansible_inventory_file` | string | `"{{ ansible_base_dir }}/hosts.yml"` | Путь к файлу инвентори |


#### Конфигурация производительности

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `async_timeout` | integer | `300` | Таймаут асинхронных задач в секундах |
| `retries` | integer | `3` | Количество повторов для неудачных задач |
| `retry_delay` | integer | `5` | Задержка между повторами в секундах |

#### Конфигурация логирования

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|--------------|----------|
| `log_file` | string | `"/var/log/ansible-changes.log"` | Путь к файлу лога для структурированного логирования |

## Примеры использования

### Базовое использование

```yaml
- name: Импорт конфигурации Proxmox
  ansible.builtin.include_role:
    name: proxmox_import_config
  vars:
    host_name: "web-server-01"
    host_vars: "web_server_01"
```

### Расширенное использование с отладкой

```yaml
- name: Импорт конфигурации Proxmox с отладкой
  ansible.builtin.include_role:
    name: proxmox_import_config
  vars:
    host_name: "web-server-01"
    host_vars: "web_server_01"
    debug_mode: true
    log_file: "/var/log/proxmox-import.log"
    strict_validation: true
```

### Пользовательские пути

```yaml
- name: Импорт конфигурации Proxmox с пользовательскими путями
  ansible.builtin.include_role:
    name: proxmox_import_config
  vars:
    host_name: "web-server-01"
    host_vars: "web_server_01"
    ansible_base_dir: "/opt/ansible"
    secrets_file_path: "/opt/secrets/proxmox-secrets.yaml"
    backup_dir: "/opt/backups/ansible"
```

## Структура файла секретов

Файл секретов должен содержать переменные с указанным префиксом:

```yaml
# secrets.yaml
web_server_01_pve_node: "pve-node-01"
web_server_01_pve_api_user: "root@pam"
web_server_01_pve_api_password: "secure_password"
web_server_01_pve_lxc_root_password: "root_password"
web_server_01_pve_lxc_root_authorized_pubkey: "/path/to/ssh/key"
web_server_01_admin_user: "admin"
web_server_01_admin_password: "admin_password"
```

## Структура файла переменных хоста

Файл переменных хоста должен содержать конфигурацию LXC контейнера:

```yaml
# host_vars/web-server-01.yml
pve_lxc_name: "web-server-01"
pve_lxc_vmid: 100
pve_lxc_ostemplate_name: "ubuntu-22.04-standard_22.04-1_amd64.tar.zst"
pve_lxc_ip_address: "192.168.1.100"
pve_lxc_ip_mask: "24"
pve_lxc_ip_gateway: "192.168.1.1"
pve_lxc_nameserver: "8.8.8.8"
pve_lxc_searchdomain: "local"
pve_lxc_description: "Web server container"
```

## Структурированное логирование

Роль логирует все операции в структурированном JSON формате в указанный файл лога. Каждая запись лога содержит:

- `timestamp`: Временная метка в формате ISO 8601
- `level`: Уровень лога (INFO, WARN, ERROR)
- `event_type`: Тип операции
- `service_name`: Имя роли
- `status`: Статус операции
- `user`: Пользователь, выполняющий роль
- `host`: Целевой хост
- `playbook`: Имя playbook
- `task`: Имя задачи
- `correlation_id`: Уникальный идентификатор для трассировки
- `message`: Человекочитаемое сообщение
- `metadata`: Дополнительная контекстная информация

### Пример записи лога

```json
{
  "timestamp": "2024-01-15T10:30:45.123456Z",
  "level": "INFO",
  "event_type": "SECRETS_IMPORT",
  "service_name": "proxmox_import_config",
  "status": "SUCCESS",
  "user": "ansible",
  "host": "web-server-01",
  "playbook": "deploy-containers",
  "task": "Import secrets from file",
  "correlation_id": "1705312245",
  "message": "Secrets file imported successfully",
  "metadata": {
    "secrets_file_path": "/etc/ansible/VARS/secrets.yaml",
    "variables_loaded": 15,
    "host_vars_prefix": "web_server_01"
  }
}
```

## Обработка ошибок

Роль реализует комплексную обработку ошибок:

1. **Обнаружение ошибок**: Неудачные операции перехватываются и логируются
2. **Детальное логирование**: Все операции ошибок логируются с полным контекстом
3. **Корректное завершение**: Операции завершаются корректно с описательными сообщениями об ошибках

### Сценарии ошибок

- **Ошибка импорта секретов**: Логирование деталей ошибки и корректное завершение
- **Ошибка импорта переменных хоста**: Логирование деталей ошибки и корректное завершение
- **Ошибки синтаксиса YAML**: Логирование деталей ошибки и корректное завершение
- **Отсутствующие переменные**: Валидация и отчет об отсутствующих обязательных переменных

## Возможности валидации

### Валидация файлов
- Проверка существования и читаемости файлов
- Валидация синтаксиса YAML с использованием модуля yaml Python
- Проверка прав доступа и владельца файлов

### Валидация структуры
- Проверка присутствия обязательных переменных
- Проверка соглашений именования переменных
- Проверка типов данных и форматов

### Режим строгой валидации
При `strict_validation: true`:
- Все YAML файлы должны иметь корректный синтаксис
- Все обязательные переменные должны присутствовать
- Валидируются права доступа к файлам
- Проверяется существование хоста в инвентори

## Теги

Роль поддерживает следующие теги для выборочного выполнения:

- `always`: Задачи, выполняемые всегда
- `validate`: Задачи валидации
- `preflight`: Предварительные проверки
- `import`: Операции импорта
- `secrets`: Задачи, связанные с секретами
- `host_vars`: Задачи переменных хоста
- `logging`: Задачи логирования
- `debug`: Задачи отладочного вывода
- `summary`: Задачи сводки

### Пример: Выполнить только валидацию

```bash
ansible-playbook playbook.yml --tags validate
```

### Пример: Выполнить с отладочным выводом

```bash
ansible-playbook playbook.yml --tags debug
```

## Устранение неполадок

### Частые проблемы

1. **Файл не найден**
   - Проверьте правильность путей к файлам
   - Проверьте права доступа к файлам
   - Убедитесь, что файлы существуют перед запуском роли

2. **Ошибки синтаксиса YAML**
   - Используйте `debug_mode: true` для просмотра детальных сообщений об ошибках
   - Валидируйте синтаксис YAML вручную
   - Проверьте проблемы с отступами

3. **Отсутствующие переменные**
   - Проверьте, что имена переменных соответствуют ожидаемому префиксу
   - Проверьте структуру файла секретов
   - Убедитесь, что все обязательные переменные определены

4. **Проблемы с правами доступа**
   - Проверьте права доступа к файлам секретов и host_vars
   - Убедитесь, что директория резервных копий доступна для записи
   - Убедитесь, что директория файла лога существует и доступна для записи

### Режим отладки

Включите режим отладки для детального вывода:

```yaml
vars:
  debug_mode: true
```

### Анализ логов

Проверьте структурированный файл лога для получения детальной информации об операциях:

```bash
tail -f /var/log/ansible-changes.log | jq .
```

## Соображения безопасности

- **Чувствительные данные**: Используйте `debug_sensitive: false` в продакшене
- **Права доступа к файлам**: Убедитесь, что файлы секретов имеют ограниченные права доступа (600)
- **Безопасность логов**: Файлы логов могут содержать чувствительную информацию

## Оптимизация производительности

- **Асинхронные операции**: Длительные операции используют async с настраиваемыми таймаутами
- **Минимальные факты**: Собираются только необходимые факты
- **Эффективная валидация**: Валидация выполняется только при необходимости
- **Выборочное выполнение**: Используйте теги для выполнения только необходимых задач

## Интеграция

Эта роль предназначена для работы с другими ролями, связанными с Proxmox:

1. **Импорт конфигурации**: Эта роль (импортирует конфигурацию)
2. **Создание контейнеров**: Создание LXC контейнеров с использованием импортированной конфигурации
3. **Конфигурация контейнеров**: Настройка параметров контейнеров
4. **Развертывание сервисов**: Развертывание сервисов в контейнеры

## Лицензия

MIT

## Автор

Mad-Axell <mad.axell@gmail.com>

