# coral-edge-tpu

Ansible роль для установки и настройки поддержки Google Coral EDGE TPU в контейнерах Proxmox LXC.

## Описание

Эта роль автоматизирует установку библиотек времени выполнения Google Coral EDGE TPU и настраивает контейнеры Proxmox LXC для обеспечения проброса USB-устройств для ускорителей Coral TPU. Роль добавляет официальный репозиторий Google, устанавливает необходимые библиотеки и настраивает файл конфигурации LXC-контейнера для проброса USB-устройств и GPU-устройств.

## Требования

### Требования к управляющему узлу

- Ansible 2.14 или выше
- Python 3.9 или выше

### Требования к управляемым узлам

- Дистрибутив семейства Debian (Debian, Ubuntu)
- Среда Proxmox VE
- Доступ root или sudo
- Подключение к интернету для установки пакетов

### Зависимости

Отсутствуют

## Переменные роли

### Обязательные переменные

| Переменная | Тип | Описание |
|-----------|-----|----------|
| `pve_lxc_vmid` | string | VM ID контейнера Proxmox LXC. Используется для идентификации файла конфигурации контейнера по пути `/etc/pve/lxc/{{ pve_lxc_vmid }}.conf` |

### Опциональные переменные

Отсутствуют

## Пример Playbook

### Базовое использование

```yaml
---
- name: Настройка Coral EDGE TPU для LXC контейнера
  hosts: proxmox_hosts
  become: true
  vars:
    pve_lxc_vmid: "100"
  roles:
    - coral-edge-tpu
```

### Несколько контейнеров

```yaml
---
- name: Настройка Coral EDGE TPU для нескольких контейнеров
  hosts: proxmox_hosts
  become: true
  vars:
    pve_lxc_vmid: "{{ item }}"
  roles:
    - coral-edge-tpu
  loop:
    - "100"
    - "101"
    - "102"
```

## Что делает эта роль

1. **Добавляет репозиторий Coral EDGE TPU**
   - Добавляет официальный репозиторий Google Coral EDGE TPU в источники пакетов APT системы

2. **Добавляет GPG ключ**
   - Импортирует GPG ключ для репозитория Coral EDGE TPU

3. **Обновляет кэш пакетов**
   - Обновляет кэш пакетов APT для включения пакетов из нового репозитория

4. **Устанавливает библиотеку Coral EDGE TPU**
   - Устанавливает пакет `libedgetpu1-std` (стандартная библиотека времени выполнения для Coral EDGE TPU)

5. **Настраивает LXC контейнер**
   - Настраивает проброс устройств в файле конфигурации контейнера Proxmox LXC
   - Включает проброс USB-устройств (устройства Coral TPU на /dev/bus/usb/001/ и /dev/bus/usb/004/)
   - Включает проброс GPU-устройств (/dev/dri/renderD128 и /dev/dri)
   - Устанавливает права доступа к устройствам (cgroup2.devices.allow)

## Конфигурация проброса устройств

Роль настраивает следующие пробросы устройств в LXC контейнере:

- **USB-устройства**: `/dev/bus/usb/001/` и `/dev/bus/usb/004/` (устройства Coral TPU)
- **GPU-устройства**: `/dev/dri/renderD128` и `/dev/dri` (для ускорения GPU)
- **Права доступа к устройствам**: `lxc.cgroup2.devices.allow = a` (разрешает все устройства)

## Примечания

- Эта роль специально разработана для контейнеров Proxmox VE LXC
- Роль напрямую изменяет файл конфигурации LXC контейнера
- Пути USB-устройств (001, 004) жестко заданы и могут потребовать корректировки в зависимости от конфигурации вашего оборудования
- Роль использует режим проверки для первоначальной валидации перед применением изменений
- После настройки контейнер LXC может потребовать перезапуска для вступления изменений в силу

## Устранение неполадок

### USB-устройство не найдено

Если ваше устройство Coral TPU находится на другой USB-шине, вам может потребоваться:
1. Определить правильную USB-шину: `lsusb | grep Coral`
2. Проверить путь к устройству: `ls -la /dev/bus/usb/`
3. Изменить задачи роли для использования правильного пути к устройству

### Ошибки отказа в доступе

Убедитесь, что:
- Playbook запускается с `become: true`
- Пользователь имеет права на изменение директории `/etc/pve/lxc/`
- Файл конфигурации LXC контейнера существует и доступен для записи

### Ошибка установки пакетов

Проверьте:
- Доступность подключения к интернету
- Корректность разрешения DNS
- Успешность импорта GPG ключа
- Доступность URL репозитория

## Лицензия

MIT

## Автор

Mad-Axell [mad.axell@gmail.com]

## Поддержка

По вопросам и проблемам обращайтесь к автору или создайте issue в репозитории.

