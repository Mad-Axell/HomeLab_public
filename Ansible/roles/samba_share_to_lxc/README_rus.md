# samba_share_to_lxc - Русская Документация

Ansible роль для монтирования SMB/CIFS шаров на Proxmox хосте и их привязки к LXC контейнерам.

## Описание

Эта роль автоматизирует полный процесс монтирования SMB/CIFS сетевых шаров на хосте Proxmox VE и делает их доступными внутри LXC контейнеров через bind-mount. Роль выполняет:

- Установку необходимых пакетов (`cifs-utils`)
- Создание защищенного файла с учетными данными для SMB аутентификации
- Настройку `/etc/fstab` для постоянного монтирования
- Монтирование SMB шаров на хосте
- Привязку смонтированных шаров к LXC контейнерам
- Опциональную перезагрузку контейнера для применения изменений

Роль идемпотентна и может безопасно выполняться многократно. Она проверяет окружение перед внесением изменений и предоставляет понятные сообщения об ошибках.

## Требования

### Узел управления

- Ansible 2.9 или выше
- Python 3.6+

### Управляемый узел

- Хост Proxmox VE
- Debian или Ubuntu (дистрибутивы семейства Debian)
- Доступ root или sudo
- Сетевое подключение к SMB серверу
- Существующий LXC контейнер (указывается через `samba_lxc_id`)

## Переменные роли

### Обязательные переменные

Эти переменные должны быть заданы в playbook или host_vars:

| Переменная | Тип | Описание |
|-----------|-----|----------|
| `samba_lxc_id` | Integer | ID LXC контейнера (например, 101, 102) |
| `samba_smb_user` | String | Имя пользователя SMB для аутентификации |
| `samba_smb_password` | String | Пароль SMB для аутентификации |

### Опциональные переменные

| Переменная | Тип | По умолчанию | Описание |
|-----------|-----|--------------|----------|
| `samba_smb_server` | String | `"10.20.30.200"` | IP-адрес или hostname SMB сервера |
| `samba_smb_share` | String | `"frigate"` | Имя SMB шара |
| `samba_mount_point` | String | `"/mnt/frigate_host"` | Точка монтирования на Proxmox хосте |
| `samba_container_mount` | String | `"/mnt/frigate"` | Точка монтирования внутри LXC контейнера |
| `samba_cred_file` | String | `"/root/.smb-frigate"` | Путь к файлу с учетными данными |
| `samba_cifs_version` | String | `"3.0"` | Версия протокола CIFS |
| `samba_cifs_options` | List | `["iocharset=utf8", "nofail", "_netdev"]` | Дополнительные опции монтирования CIFS |
| `samba_lxc_mp_id` | String | `"mp0"` | ID точки монтирования LXC (mp0, mp1, и т.д.) |
| `samba_lxc_restart` | Boolean | `true` | Перезапустить LXC контейнер после настройки |

## Зависимости

Отсутствуют. Роль независима и не требует других ролей.

## Примеры Playbook

### Базовое использование

```yaml
---
- name: Монтирование SMB шара в LXC контейнер
  hosts: proxmox_host
  become: true
  vars:
    samba_lxc_id: 101
    samba_smb_user: "frigate_user"
    samba_smb_password: "SecurePassword123"
    samba_smb_server: "10.20.30.200"
    samba_smb_share: "frigate"
    samba_mount_point: "/mnt/frigate_host"
    samba_container_mount: "/mnt/frigate"
  
  roles:
    - samba_share_to_lxc
```

### Расширенное использование с пользовательскими опциями

```yaml
---
- name: Монтирование SMB шара с пользовательской конфигурацией
  hosts: proxmox_host
  become: true
  vars:
    samba_lxc_id: 102
    samba_smb_user: "backup_user"
    samba_smb_password: "{{ vault_smb_password }}"
    samba_smb_server: "192.168.1.100"
    samba_smb_share: "backups"
    samba_mount_point: "/mnt/backup_host"
    samba_container_mount: "/mnt/backup"
    samba_lxc_mp_id: "mp1"
    samba_cifs_version: "2.1"
    samba_cifs_options:
      - "iocharset=utf8"
      - "nofail"
      - "_netdev"
      - "uid=1000"
      - "gid=1000"
    samba_lxc_restart: false
  
  roles:
    - samba_share_to_lxc
```

### Использование Ansible Vault для секретов

```yaml
---
- name: Монтирование SMB шара с зашифрованным паролем из vault
  hosts: proxmox_host
  become: true
  vars:
    samba_lxc_id: 101
    samba_smb_user: "{{ vault_smb_user }}"
    samba_smb_password: "{{ vault_smb_password }}"
    samba_smb_server: "10.20.30.200"
    samba_smb_share: "frigate"
  
  roles:
    - samba_share_to_lxc
```

## Теги задач

Роль поддерживает следующие теги для выборочного выполнения:

| Тег | Описание |
|-----|----------|
| `validation` | Задачи валидации (проверки окружения) |
| `packages` | Задачи установки пакетов |
| `setup` | Задачи настройки (директории, учетные данные) |
| `credentials` | Создание файла с учетными данными |
| `fstab` | Конфигурация `/etc/fstab` |
| `mount` | Операции монтирования |
| `lxc` | Задачи конфигурации LXC |
| `restart` | Перезапуск контейнера |

### Пример: Выполнить только задачи монтирования

```bash
ansible-playbook playbook.yml --tags mount
```

### Пример: Пропустить перезапуск контейнера

```bash
ansible-playbook playbook.yml --skip-tags restart
```

## Как это работает

1. **Валидация**: Проверяет, что выполнение происходит на Proxmox хосте и что LXC контейнер существует
2. **Установка пакетов**: Устанавливает `cifs-utils`, если еще не установлен
3. **Создание директории**: Создает директорию точки монтирования на хосте
4. **Учетные данные**: Создает защищенный файл с учетными данными (`/root/.smb-frigate` по умолчанию)
5. **Конфигурация Fstab**: Добавляет запись монтирования в `/etc/fstab` для постоянства
6. **Монтирование**: Монтирует SMB шар на хосте
7. **Проверка**: Проверяет, что шар успешно смонтирован
8. **Конфигурация LXC**: Добавляет или обновляет запись bind-mount в конфиге LXC контейнера
9. **Перезапуск контейнера**: Опционально перезагружает контейнер для применения изменений

## Соображения безопасности

- Файл с учетными данными создается с правами `0600` (читаемый только root)
- Пароль хранится в файле учетных данных, а не передается как аргумент командной строки
- Используйте Ansible Vault для хранения паролей в playbook
- Роль использует `no_log: false` для задачи с учетными данными (можно изменить на `true` для дополнительной безопасности)

## Устранение неполадок

### Перезапуск контейнера не удается

Если `pct reboot` не работает, убедитесь:
- ID контейнера указан правильно
- У вас есть необходимые права доступа
- Контейнер не заблокирован

### Монтирование не удается

Проверьте:
- SMB сервер доступен с Proxmox хоста
- Учетные данные правильные
- Имя SMB шара указано правильно
- Файрвол разрешает трафик CIFS (порты 445, 139)

### Bind-mount LXC не работает

Проверьте:
- Файл конфигурации контейнера существует по пути `/etc/pve/lxc/{id}.conf`
- Директория точки монтирования существует на хосте
- Контейнер был перезапущен после конфигурации

## Ограничения

- Поддерживает только дистрибутивы семейства Debian/Ubuntu
- Требует хост Proxmox VE (не совместимо с другими платформами виртуализации)
- Учетные данные SMB хранятся в файле в открытом виде (используйте права файловой системы для безопасности)
- Только одна точка монтирования на ID контейнера может быть настроена за одно выполнение роли

## Лицензия

MIT

## Информация об авторе

**Автор**: Mad-Axell  
**Email**: mad.axell@gmail.com

## Поддержка

По вопросам, проблемам или вкладу в проект обращайтесь в репозиторий проекта или к автору.

